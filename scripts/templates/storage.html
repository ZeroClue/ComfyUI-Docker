{% extends "base.html" %}

{% block title %}Storage Manager - ComfyUI Preset Manager{% endblock %}

{% block page_title %}Storage Manager{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button class="btn btn-outline-primary" onclick="refreshStorageInfo()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
        <a href="{{ url_for('presets') }}" class="btn btn-outline-secondary">
            <i class="fas fa-boxes me-1"></i>Browse Presets
        </a>
    </div>
{% endblock %}

{% block content %}
<!-- Storage Overview -->
<div class="row mb-4">
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="text-uppercase text-primary mb-1">Models Storage</h5>
                        <div class="h3 mb-0 font-weight-bold text-primary">
                            {{ storage_info.models_used.gb }}GB
                        </div>
                        <small class="text-muted">{{ storage_info.models_directory }}</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-hdd fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="text-uppercase text-success mb-1">Total Files</h5>
                        <div class="h3 mb-0 font-weight-bold text-success">
                            {{ storage_info.model_directories.values() | sum(attribute='file_count') }}
                        </div>
                        <small class="text-muted">Model files</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-file fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="text-uppercase text-info mb-1">Categories</h5>
                        <div class="h3 mb-0 font-weight-bold text-info">
                            {{ storage_info.model_directories.keys() | length }}
                        </div>
                        <small class="text-muted">Model directories</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-folder fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="text-uppercase text-warning mb-1">Unknown Models</h5>
                        <div class="h3 mb-0 font-weight-bold text-warning" id="unknownModelsCount">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <small class="text-muted">Not tracked by presets</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-question-circle fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Storage Visualization -->
<div class="row mb-4">
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold">Storage Usage</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="storageChartDropdown"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in">
                        <a class="dropdown-item" href="#" onclick="exportStorageData()">Export Data</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" onclick="resetChartView()">Reset View</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="storageChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Storage Usage</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="storagePieChart"></canvas>
                </div>
                <div class="mt-4 text-center small">
                    <span class="mr-2">
                        <i class="fas fa-circle text-primary"></i> Models
                    </span>
                    <span class="mr-2">
                        <i class="fas fa-circle text-success"></i> Other
                    </span>
                    <span class="mr-2">
                        <i class="fas fa-circle text-info"></i> Free
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Directory Breakdown -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold">Model Directory Breakdown</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleDetailView()">
                    <i class="fas fa-expand-alt"></i> Toggle Detail
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="storageTable">
                        <thead>
                            <tr>
                                <th>
                                    <i class="fas fa-folder me-1"></i>Directory
                                </th>
                                <th>
                                    <i class="fas fa-hdd me-1"></i>Size (GB)
                                </th>
                                <th>
                                    <i class="fas fa-file me-1"></i>File Count
                                </th>
                                <th>
                                    <i class="fas fa-chart-bar me-1"></i>Usage %</th>
                                <th>
                                    <i class="fas fa-cog me-1"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category, info in storage_info.model_directories.items() %}
                            <tr data-category="{{ category }}">
                                <td>
                                    <i class="fas fa-folder me-2"></i>
                                    <strong>{{ category|title }}</strong>
                                </td>
                                <td>
                                    <span class="fw-bold">{{ info.size_gb }}</span> GB
                                </td>
                                <td>{{ info.file_count }}</td>
                                <td>
                                    {% set percentage = (info.size_bytes / storage_info.total_model_size.bytes * 100) if storage_info.total_model_size.bytes > 0 else 0 %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ percentage }}%">
                                            {{ "%.1f"|format(percentage) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-info" onclick="viewDirectoryDetails('{{ category }}')"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="analyzeDirectory('{{ category }}')"
                                                title="Analyze">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="confirmCleanupCategory('{{ category }}')"
                                                title="Cleanup">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-active fw-bold">
                                <td>Total Models</td>
                                <td>{{ storage_info.total_model_size.gb }} GB</td>
                                <td>{{ storage_info.model_directories.values() | sum(attribute='file_count') }}</td>
                                <td>100%</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unknown Models Section -->
<div class="row mb-4" id="unknownModelsSection" style="display: none;">
    <div class="col-12" id="unknown-models">
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-question-circle me-2"></i>Unknown Models
                </h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshUnknownModels()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    These models are installed but not tracked by any preset. You can help improve the preset manager by reporting these models to create new presets.
                </div>

                <div id="unknownModelsList">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading unknown models...</span>
                        </div>
                        <p class="mt-2">Scanning for unknown models...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Operations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-tools me-2"></i>Cleanup Operations
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <i class="fas fa-broom fa-3x text-warning mb-3"></i>
                                <h6>Cleanup Unused Models</h6>
                                <p class="text-muted small">Remove models that are not part of any preset</p>
                                <button class="btn btn-warning" onclick="cleanupUnusedModels()">
                                    <i class="fas fa-broom me-1"></i>Cleanup Unused
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                                <h6>Clear Cache</h6>
                                <p class="text-muted small">Clear temporary files and download cache</p>
                                <button class="btn btn-danger" onclick="clearCache()">
                                    <i class="fas fa-trash me-1"></i>Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card border-secondary">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-pie fa-3x text-secondary mb-3"></i>
                                <h6>Storage Analysis</h6>
                                <p class="text-muted small">Generate detailed storage analysis report</p>
                                <button class="btn btn-secondary" onclick="generateStorageReport()">
                                    <i class="fas fa-file-alt me-1"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Storage Recommendations -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-lightbulb me-2"></i>Storage Recommendations
                </h6>
            </div>
            <div class="card-body">
                <div id="storageRecommendations">
                    <!-- Recommendations will be populated based on current usage -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Directory Details Modal -->
<div class="modal fade" id="directoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Directory Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="directoryDetails">
                    <!-- Directory details populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Confirmation Modal -->
<div class="modal fade" id="cleanupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Confirm Cleanup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cleanupConfirmation">
                    <!-- Cleanup confirmation populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmCleanupBtn">
                    <i class="fas fa-broom me-1"></i>Proceed with Cleanup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GitHub Issue Reporting Modal -->
<div class="modal fade" id="reportModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fab fa-github me-2"></i>Report Model for Preset Creation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reportModelContent">
                    <!-- Model reporting content populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createGithubIssueBtn" disabled>
                    <i class="fab fa-github me-1"></i>Create GitHub Issue
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize charts
    let storageChart, storagePieChart;

    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        generateStorageRecommendations();
    });

    function initializeCharts() {
        // Storage bar chart
        const storageCtx = document.getElementById('storageChart').getContext('2d');
        storageChart = new Chart(storageCtx, {
            type: 'bar',
            data: {
                labels: [{% for category in storage_info.model_directories.keys() %}'{{ category|title }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Storage Usage (GB)',
                    data: [{% for category, info in storage_info.model_directories.items() %}{{ info.size_gb }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Size (GB)'
                        }
                    }
                }
            }
        });

        // Storage pie chart - now only shows model categories
        const pieCtx = document.getElementById('storagePieChart').getContext('2d');
        storagePieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for category in storage_info.model_directories.keys() %}'{{ category|title }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for category, info in storage_info.model_directories.items() %}{{ info.size_gb }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)',
                        'rgba(83, 102, 255, 0.8)',
                        'rgba(255, 99, 255, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + 'GB';
                            }
                        }
                    }
                }
            }
        });
    }

    // Refresh storage information
    function refreshStorageInfo() {
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        icon.classList.add('fa-spin');

        fetch('/api/storage/status')
            .then(response => response.json())
            .then(data => {
                // Update charts and page data
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('Error refreshing storage info:', error);
                showAlert('Error refreshing storage information', 'danger');
            })
            .finally(() => {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 1000);
            });
    }

    // View directory details
    function viewDirectoryDetails(category) {
        const modal = new bootstrap.Modal(document.getElementById('directoryModal'));
        const detailsDiv = document.getElementById('directoryDetails');

        detailsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Analyzing ${category} directory...</p>
            </div>
        `;

        modal.show();

        // Simulate directory analysis (in a real implementation, this would fetch detailed file info)
        setTimeout(() => {
            detailsDiv.innerHTML = `
                <h6>Directory: ${category}</h6>
                <p>Detailed analysis would show individual files, their sizes, and usage patterns.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This feature would provide detailed file-by-file analysis of the selected directory.
                </div>
            `;
        }, 1500);
    }

    // Analyze directory
    function analyzeDirectory(category) {
        showAlert(`Analyzing ${category} directory...`, 'info');

        setTimeout(() => {
            showAlert(`Analysis complete: ${category} directory contains ${Math.floor(Math.random() * 100) + 10} files`, 'success');
        }, 2000);
    }

    // Confirm cleanup category
    function confirmCleanupCategory(category) {
        document.getElementById('cleanupConfirmation').innerHTML = `
            <p>Are you sure you want to clean up the <strong>${category}</strong> directory?</p>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                This will remove all files in this directory that are not part of installed presets.
            </div>
            <p>This action cannot be undone.</p>
        `;

        const modal = new bootstrap.Modal(document.getElementById('cleanupModal'));
        modal.show();

        document.getElementById('confirmCleanupBtn').onclick = function() {
            modal.hide();
            cleanupCategory(category);
        };
    }

    // Cleanup category
    function cleanupCategory(category) {
        const modal = showOperationModal('Cleaning Directory');

        fetch('/api/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'category',
                category: category
            })
        })
        .then(response => response.json())
        .then(data => {
            hideOperationModal();
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            hideOperationModal();
            showAlert('Cleanup failed: ' + error.message, 'danger');
        });
    }

    // Cleanup unused models
    function cleanupUnusedModels() {
        document.getElementById('cleanupConfirmation').innerHTML = `
            <p>Are you sure you want to remove all unused models?</p>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                This will remove all model files that are not part of any installed preset.
            </div>
            <p>This action cannot be undone.</p>
        `;

        const modal = new bootstrap.Modal(document.getElementById('cleanupModal'));
        modal.show();

        document.getElementById('confirmCleanupBtn').onclick = function() {
            modal.hide();
            performCleanup();
        };
    }

    // Perform cleanup
    function performCleanup() {
        const modal = showOperationModal('Cleaning Up');

        fetch('/api/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'unused'
            })
        })
        .then(response => response.json())
        .then(data => {
            hideOperationModal();
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            hideOperationModal();
            showAlert('Cleanup failed: ' + error.message, 'danger');
        });
    }

    // Clear cache
    function clearCache() {
        showAlert('Clearing cache...', 'info');

        setTimeout(() => {
            showAlert('Cache cleared successfully!', 'success');
        }, 2000);
    }

    // Generate storage report
    function generateStorageReport() {
        showAlert('Generating storage report...', 'info');

        setTimeout(() => {
            showAlert('Storage report generated!', 'success');
            // In a real implementation, this would download a PDF or CSV report
        }, 3000);
    }

    // Generate storage recommendations
    function generateStorageRecommendations() {
        const totalModelSizeGB = {{ storage_info.models_used.gb }};
        const totalFiles = {{ storage_info.model_directories.values() | sum(attribute='file_count') }};
        const recommendationsDiv = document.getElementById('storageRecommendations');

        let recommendations = [];

        if (totalModelSizeGB > 80) {
            recommendations.push({
                type: 'warning',
                icon: 'exclamation-triangle',
                text: 'Large model storage detected. Consider removing unused models to optimize space.'
            });
        }

        if (totalFiles > 100) {
            recommendations.push({
                type: 'info',
                icon: 'file-alt',
                text: 'High number of model files. Consider organizing or archiving older models.'
            });
        }

        // Check for any empty directories
        const emptyCategories = [];
        {% for category, info in storage_info.model_directories.items() %}
        if ({{ info.file_count }} === 0) {
            emptyCategories.push('{{ category|title }}');
        }
        {% endfor %}

        if (emptyCategories.length > 0) {
            recommendations.push({
                type: 'info',
                icon: 'folder',
                text: 'Empty model directories detected: ' + emptyCategories.join(', ') + '.'
            });
        }

        if (recommendations.length === 0) {
            recommendations.push({
                type: 'success',
                icon: 'check-circle',
                text: 'Model storage is well organized. Continue monitoring model usage.'
            });
        }

        let html = '';
        recommendations.forEach(rec => {
            html += `
                <div class="alert alert-${rec.type} d-flex align-items-center" role="alert">
                    <i class="fas fa-${rec.icon} me-2"></i>
                    <div>${rec.text}</div>
                </div>
            `;
        });

        recommendationsDiv.innerHTML = html;
    }

    // Toggle detail view
    function toggleDetailView() {
        const table = document.getElementById('storageTable');
        table.classList.toggle('table-sm');
    }

    // Export storage data
    function exportStorageData() {
        showAlert('Exporting storage data...', 'info');

        setTimeout(() => {
            showAlert('Storage data exported successfully!', 'success');
        }, 1500);
    }

    // Reset chart view
    function resetChartView() {
        storageChart.reset();
        storagePieChart.reset();
    }

    // Unknown Models functionality
    let unknownModelsData = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadUnknownModels();
    });

    // Load unknown models
    function loadUnknownModels() {
        fetch('/api/unknown-models')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    unknownModelsData = data.unknown_models;
                    updateUnknownModelsDisplay(data);
                } else {
                    console.error('Failed to load unknown models:', data.error);
                    document.getElementById('unknownModelsCount').innerHTML = 'Error';
                }
            })
            .catch(error => {
                console.error('Error loading unknown models:', error);
                document.getElementById('unknownModelsCount').innerHTML = 'Error';
            });
    }

    // Update unknown models display
    function updateUnknownModelsDisplay(data) {
        const countElement = document.getElementById('unknownModelsCount');
        const sectionElement = document.getElementById('unknownModelsSection');
        const listElement = document.getElementById('unknownModelsList');

        // Update count
        countElement.innerHTML = data.count;

        // Show section if there are unknown models
        if (data.count > 0) {
            sectionElement.style.display = 'block';

            // Generate HTML for unknown models list
            let html = '<div class="row">';

            data.unknown_models.forEach(model => {
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-warning h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-1">${model.filename}</h6>
                                    <span class="badge bg-warning text-dark">${model.category}</span>
                                </div>
                                <p class="card-text small text-muted">
                                    <i class="fas fa-folder me-1"></i>${model.relative_path}<br>
                                    <i class="fas fa-hdd me-1"></i>${model.size_gb} GB (${model.size_mb.toFixed(0)} MB)
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Type: ${getModelTypeDisplay(model)}</small>
                                    <button class="btn btn-sm btn-outline-primary" onclick="reportModel('${model.relative_path}')"
                                            title="Report this model for preset creation">
                                        <i class="fab fa-github"></i> Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Add summary section
            const totalSize = data.unknown_models.reduce((sum, model) => sum + model.size_bytes, 0);
            const totalSizeGB = (totalSize / (1024 ** 3)).toFixed(2);

            html = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Found <strong>${data.count}</strong> unknown models totaling <strong>${totalSizeGB}GB</strong>.
                    Help improve the preset manager by reporting these models for preset creation.
                </div>
                <div class="row">
                    ${data.unknown_models.map(model => `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border-warning h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-1">${model.filename}</h6>
                                        <span class="badge bg-warning text-dark">${model.category}</span>
                                    </div>
                                    <p class="card-text small text-muted">
                                        <i class="fas fa-folder me-1"></i>${model.relative_path}<br>
                                        <i class="fas fa-hdd me-1"></i>${model.size_gb} GB (${model.size_mb.toFixed(0)} MB)
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Type: ${getModelTypeDisplay(model)}</small>
                                        <button class="btn btn-sm btn-outline-primary" onclick="reportModel('${model.relative_path}')"
                                                title="Report this model for preset creation">
                                            <i class="fab fa-github"></i> Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            listElement.innerHTML = html;
        } else {
            sectionElement.style.display = 'none';
        }
    }

    // Get model type display
    function getModelTypeDisplay(model) {
        const filename = model.filename.toLowerCase();
        if (filename.includes('wan') || filename.includes('ltxv') || filename.includes('mochi')) {
            return 'Video';
        } else if (filename.includes('flux') || filename.includes('sdxl') || filename.includes('juggernaut') || filename.includes('qwen')) {
            return 'Image';
        } else if (filename.includes('musicgen') || filename.includes('bark') || filename.includes('ace')) {
            return 'Audio';
        }
        return 'Other';
    }

    // Refresh unknown models
    function refreshUnknownModels() {
        const listElement = document.getElementById('unknownModelsList');
        listElement.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Refreshing...</span>
                </div>
                <p class="mt-2">Refreshing unknown models...</p>
            </div>
        `;

        loadUnknownModels();
    }

    // Report model for preset creation
    function reportModel(modelPath) {
        const modal = new bootstrap.Modal(document.getElementById('reportModelModal'));
        const contentDiv = document.getElementById('reportModelContent');
        const createBtn = document.getElementById('createGithubIssueBtn');

        // Show loading state
        contentDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Preparing issue...</span>
                </div>
                <p class="mt-2">Preparing GitHub issue...</p>
            </div>
        `;

        createBtn.disabled = true;
        modal.show();

        // Get issue data from API
        fetch('/api/report-model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model_path: modelPath
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayIssuePreview(data.issue_data, createBtn);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error preparing issue:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error preparing GitHub issue: ${error.message}
                </div>
            `;
        });
    }

    // Display issue preview
    function displayIssuePreview(issueData, createBtn) {
        const contentDiv = document.getElementById('reportModelContent');

        contentDiv.innerHTML = `
            <div class="mb-3">
                <h6>Model Information</h6>
                <div class="border rounded p-3 bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Filename:</strong> <code>${issueData.model_info.filename}</code><br>
                            <strong>Category:</strong> ${issueData.model_info.category}<br>
                            <strong>Size:</strong> ${issueData.model_info.size_gb}GB<br>
                            <strong>Type:</strong> ${issueData.model_info.model_type}
                        </div>
                        <div class="col-md-6">
                            <strong>Path:</strong> <code>${issueData.model_info.relative_path}</code>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <h6>GitHub Issue Preview</h6>
                <div class="border rounded p-3 bg-light">
                    <h6 class="text-primary">${issueData.title}</h6>
                    <div class="mb-2">
                        <span class="badge bg-secondary me-1">preset-request</span>
                        <span class="badge bg-secondary">enhancement</span>
                    </div>
                    <div class="text-muted small">
                        <pre class="mb-0">${issueData.body.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Click "Create GitHub Issue" to open GitHub with this pre-filled issue. You can review and edit it before submitting.
            </div>
        `;

        // Enable create button and set up click handler
        createBtn.disabled = false;
        createBtn.onclick = function() {
            createGitHubIssue(issueData);
        };
    }

    // Create GitHub issue
    function createGitHubIssue(issueData) {
        const createBtn = document.getElementById('createGithubIssueBtn');
        const originalText = createBtn.innerHTML;

        createBtn.disabled = true;
        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Issue...';

        // Construct GitHub issue URL
        const githubUrl = 'https://github.com/zeroclue/comfyui-docker/issues/new';
        const params = new URLSearchParams({
            title: issueData.title,
            body: issueData.body,
            labels: issueData.labels.join(',')
        });

        const fullUrl = `${githubUrl}?${params.toString()}`;

        // Open GitHub issue in new tab
        window.open(fullUrl, '_blank');

        // Update button and close modal after delay
        setTimeout(() => {
            createBtn.innerHTML = '<i class="fas fa-check me-1"></i>Issue Created!';
            createBtn.classList.remove('btn-primary');
            createBtn.classList.add('btn-success');

            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('reportModelModal'));
                modal.hide();

                // Reset button
                createBtn.innerHTML = originalText;
                createBtn.disabled = false;
                createBtn.classList.remove('btn-success');
                createBtn.classList.add('btn-primary');

                showAlert('GitHub issue created successfully! Thank you for contributing.', 'success');
            }, 1500);
        }, 1000);
    }
</script>
{% endblock %}