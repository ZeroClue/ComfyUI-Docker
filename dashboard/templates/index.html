{% extends "base.html" %}

{% block title %}Home - ComfyUI Dashboard{% endblock %}

{% block page_breadcrumb %}
<span class="text-text-primary font-medium">Dashboard</span>
{% endblock %}

{% block content %}
<div class="p-6 lg:p-8" x-data="homeDashboard()" x-init="initHomeDashboard()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold tracking-tight mb-2">Welcome back</h1>
        <p class="text-text-secondary text-sm">Your AI workspace is ready</p>
    </div>

    <!-- Quick Actions -->
    <section class="mb-8">
        <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% from 'components/cards.html' import quick_action %}
            {{ quick_action('▶', 'Run Workflow', 'Execute saved workflow', '/workflows') }}
            {{ quick_action('↓', 'Install Model', 'Browse & install presets', '/models') }}
            {{ quick_action('⚡', 'Quick Generate', 'Fast image generation', '/generate?mode=quick') }}
            {{ quick_action('◉', 'Check Status', 'View system status', '/settings?tab=system') }}
        </div>
    </section>

    <!-- Stats Grid -->
    <section class="mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total Generations -->
            <div class="stat-card bg-bg-secondary border border-border-subtle rounded-lg p-4 card-hover">
                <div class="stat-header flex items-center justify-between mb-3">
                    <div class="stat-icon w-9 h-9 rounded-md flex items-center justify-center text-base bg-accent-primary/15 text-accent-primary">◉</div>
                    <span class="stat-trend text-xs font-semibold px-2 py-0.5 rounded-full text-accent-success bg-accent-success/10">↑ 12%</span>
                </div>
                <div class="stat-value text-2xl font-bold tracking-tight mb-1" x-text="stats.totalGenerations">1,284</div>
                <div class="stat-label text-text-secondary text-xs">Total Generations</div>
            </div>

            <!-- Models Installed -->
            <div class="stat-card bg-bg-secondary border border-border-subtle rounded-lg p-4 card-hover">
                <div class="stat-header flex items-center justify-between mb-3">
                    <div class="stat-icon w-9 h-9 rounded-md flex items-center justify-center text-base bg-accent-success/15 text-accent-success">◌</div>
                    <span class="stat-trend text-xs font-semibold px-2 py-0.5 rounded-full text-accent-success bg-accent-success/10">↑ 3</span>
                </div>
                <div class="stat-value text-2xl font-bold tracking-tight mb-1" x-text="stats.modelsInstalled">12</div>
                <div class="stat-label text-text-secondary text-xs">Models Installed</div>
            </div>

            <!-- Storage Used -->
            <div class="stat-card bg-bg-secondary border border-border-subtle rounded-lg p-4 card-hover">
                <div class="stat-header flex items-center justify-between mb-3">
                    <div class="stat-icon w-9 h-9 rounded-md flex items-center justify-center text-base bg-accent-warning/15 text-accent-warning">◫</div>
                    <span class="stat-trend text-xs font-semibold px-2 py-0.5 rounded-full text-accent-error bg-accent-error/10">↓ 8%</span>
                </div>
                <div class="stat-value text-2xl font-bold tracking-tight mb-1" x-text="stats.storageUsed">24.5 GB</div>
                <div class="stat-label text-text-secondary text-xs">Storage Used</div>
            </div>

            <!-- Active Workflows -->
            <div class="stat-card bg-bg-secondary border border-border-subtle rounded-lg p-4 card-hover">
                <div class="stat-header flex items-center justify-between mb-3">
                    <div class="stat-icon w-9 h-9 rounded-md flex items-center justify-center text-base bg-accent-info/15 text-accent-info">◐</div>
                    <span class="stat-trend text-xs font-semibold px-2 py-0.5 rounded-full text-accent-success bg-accent-success/10">↑ 2</span>
                </div>
                <div class="stat-value text-2xl font-bold tracking-tight mb-1" x-text="stats.activeWorkflows">8</div>
                <div class="stat-label text-text-secondary text-xs">Active Workflows</div>
            </div>
        </div>
    </section>

    <!-- Download Queue -->
    <section class="mb-8" x-data="downloadQueue()" x-init="initQueue()" x-show="hasActiveDownloads" x-cloak>
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Download Queue</h2>
            <button class="text-accent-primary text-sm font-medium hover:text-accent-secondary transition-colors"
                    @click="refreshQueue()">
                ↻ Refresh
            </button>
        </div>

        <div class="bg-bg-secondary border border-border-subtle rounded-lg p-4">
            <!-- Current Download -->
            <template x-if="currentDownload">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-accent-primary animate-pulse"></span>
                            <span class="text-sm font-medium" x-text="currentDownload.name || currentDownload.preset_id"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-text-tertiary" x-text="currentDownload.file"></span>
                            <button class="btn btn-secondary btn-xs py-1 px-2 rounded text-xs border border-border-medium hover:bg-bg-hover"
                                    @click="pauseDownload(currentDownload.preset_id)"
                                    x-show="currentDownload.status === 'downloading'">
                                Pause
                            </button>
                            <button class="btn btn-secondary btn-xs py-1 px-2 rounded text-xs border border-border-medium hover:bg-bg-hover"
                                    @click="resumeDownload(currentDownload.preset_id)"
                                    x-show="currentDownload.status === 'paused'">
                                Resume
                            </button>
                            <button class="btn bg-bg-tertiary btn-xs py-1 px-2 rounded text-xs text-text-secondary hover:bg-bg-hover"
                                    @click="cancelDownload(currentDownload.preset_id)">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress h-2 bg-bg-tertiary rounded-full overflow-hidden mb-1">
                        <div class="progress-bar-animated h-full bg-gradient-to-r from-accent-primary to-accent-secondary rounded-full transition-all duration-300"
                             :style="`width: ${currentDownload.progress || 0}%`"></div>
                    </div>

                    <!-- Progress Stats -->
                    <div class="flex items-center justify-between text-xs text-text-tertiary">
                        <span x-text="formatProgress(currentDownload)"></span>
                        <span x-text="currentDownload.eta ? `ETA: ${currentDownload.eta}` : ''"></span>
                    </div>
                </div>
            </template>

            <!-- Queued Downloads -->
            <template x-if="queuedDownloads.length > 0">
                <div class="border-t border-border-subtle pt-3">
                    <div class="text-xs text-text-tertiary mb-2">
                        <span x-text="`${queuedDownloads.length} in queue`"></span>
                    </div>
                    <div class="flex flex-col gap-2">
                        <template x-for="(item, index) in queuedDownloads" :key="item.preset_id">
                            <div class="flex items-center justify-between p-2 bg-bg-tertiary rounded-md">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-text-tertiary" x-text="`${index + 1}.`"></span>
                                    <span class="text-sm" x-text="item.name || item.preset_id"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-text-tertiary" x-text="item.download_size || ''"></span>
                                    <button class="text-xs text-text-tertiary hover:text-accent-error transition-colors"
                                            @click="removeFromQueue(item.preset_id)">
                                        ✕
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Empty State -->
            <template x-if="!currentDownload && queuedDownloads.length === 0">
                <div class="text-center py-4 text-text-tertiary text-sm">
                    No active downloads
                </div>
            </template>
        </div>
    </section>

    <!-- System Resources -->
    <section class="mb-8" x-data="systemResources()" x-init="initResources()">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">System Resources</h2>
            <div class="flex items-center gap-2">
                <span class="text-xs text-text-tertiary" x-text="lastUpdated"></span>
                <button class="btn btn-secondary btn-sm py-1.5 px-3 rounded-md text-sm font-medium border border-border-medium hover:bg-bg-hover hover:border-border-strong transition-all"
                        @click="refreshResources()"
                        :disabled="loading">
                    <span x-show="!loading">↻</span>
                    <span x-show="loading" class="animate-spin">⟳</span>
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="resources-grid">
            <!-- GPU Memory -->
            <template x-if="hasGPU">
                <div class="resource-card bg-bg-secondary border border-border-subtle rounded-lg p-3">
                    <div class="resource-header flex items-center justify-between mb-3">
                        <span class="resource-title text-sm font-medium text-text-secondary">GPU Memory</span>
                        <span class="text-xs" :class="getStatusColor(gpuMemory.percent)">● <span x-text="getStatusLabel(gpuMemory.percent)"></span></span>
                    </div>
                    <div class="resource-value text-lg font-bold mb-2" x-text="`${formatBytes(gpuMemory.used)} / ${formatBytes(gpuMemory.total)}`">-- / -- GB</div>
                    <div class="resource-bar h-1.5 bg-bg-tertiary rounded-full overflow-hidden mb-1">
                        <div class="resource-fill h-full rounded-full transition-all duration-200" :class="getBarColor(gpuMemory.percent)" :style="`width: ${gpuMemory.percent}%;`"></div>
                    </div>
                    <div class="resource-label text-xs text-text-tertiary" x-text="`${gpuMemory.percent.toFixed(1)}% utilized`">--% utilized</div>
                </div>
            </template>

            <!-- GPU Utilization (shown when GPU available) -->
            <template x-if="hasGPU">
                <div class="resource-card bg-bg-secondary border border-border-subtle rounded-lg p-3">
                    <div class="resource-header flex items-center justify-between mb-3">
                        <span class="resource-title text-sm font-medium text-text-secondary">GPU Utilization</span>
                        <span class="text-xs" :class="getStatusColor(gpuUtilization)">● <span x-text="getStatusLabel(gpuUtilization)"></span></span>
                    </div>
                    <div class="resource-value text-lg font-bold mb-2" x-text="`${gpuUtilization.toFixed(1)}%`">--%</div>
                    <div class="resource-bar h-1.5 bg-bg-tertiary rounded-full overflow-hidden mb-1">
                        <div class="resource-fill h-full rounded-full transition-all duration-200" :class="getBarColor(gpuUtilization)" :style="`width: ${gpuUtilization}%;`"></div>
                    </div>
                    <div class="resource-label text-xs text-text-tertiary" x-text="gpuName">GPU</div>
                </div>
            </template>

            <!-- System Memory -->
            <div class="resource-card bg-bg-secondary border border-border-subtle rounded-lg p-3">
                <div class="resource-header flex items-center justify-between mb-3">
                    <span class="resource-title text-sm font-medium text-text-secondary">System Memory</span>
                    <span class="text-xs" :class="getStatusColor(memory.percent)">● <span x-text="getStatusLabel(memory.percent)"></span></span>
                </div>
                <div class="resource-value text-lg font-bold mb-2" x-text="`${formatBytes(memory.used)} / ${formatBytes(memory.total)}`">-- / -- GB</div>
                <div class="resource-bar h-1.5 bg-bg-tertiary rounded-full overflow-hidden mb-1">
                    <div class="resource-fill h-full rounded-full transition-all duration-200" :class="getBarColor(memory.percent)" :style="`width: ${memory.percent}%;`"></div>
                </div>
                <div class="resource-label text-xs text-text-tertiary" x-text="`${memory.percent.toFixed(1)}% utilized`">--% utilized</div>
            </div>

            <!-- Disk Space -->
            <div class="resource-card bg-bg-secondary border border-border-subtle rounded-lg p-3">
                <div class="resource-header flex items-center justify-between mb-3">
                    <span class="resource-title text-sm font-medium text-text-secondary">Disk Space</span>
                    <span class="text-xs" :class="getStatusColor(disk.percent)">● <span x-text="getStatusLabel(disk.percent)"></span></span>
                </div>
                <div class="resource-value text-lg font-bold mb-2" x-text="`${formatBytes(disk.used)} / ${formatBytes(disk.total)}`">-- / -- GB</div>
                <div class="resource-bar h-1.5 bg-bg-tertiary rounded-full overflow-hidden mb-1">
                    <div class="resource-fill h-full rounded-full transition-all duration-200" :class="getBarColor(disk.percent)" :style="`width: ${disk.percent}%;`"></div>
                </div>
                <div class="resource-label text-xs text-text-tertiary" x-text="`${disk.percent.toFixed(1)}% utilized`">--% utilized</div>
            </div>
        </div>
    </section>

    <!-- Recent Models -->
    <section class="mb-8" x-data="recentModels()" x-init="loadModels()">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Recent Models</h2>
            <a href="/models" class="text-accent-primary text-sm font-medium hover:text-accent-secondary transition-colors">
                View All →
            </a>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="i in 3" :key="i">
                <div class="bg-bg-secondary border border-border-subtle rounded-lg p-4 animate-pulse">
                    <div class="h-4 bg-bg-tertiary rounded w-20 mb-3"></div>
                    <div class="h-5 bg-bg-tertiary rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-bg-tertiary rounded w-full mb-3"></div>
                    <div class="h-3 bg-bg-tertiary rounded w-1/2 mb-4"></div>
                    <div class="flex gap-2">
                        <div class="h-9 bg-bg-tertiary rounded flex-1"></div>
                        <div class="h-9 bg-bg-tertiary rounded flex-1"></div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Models Grid -->
        <div x-show="!loading && models.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="model in models" :key="model.id">
                <div class="preset-card bg-bg-secondary border border-border-subtle rounded-lg p-4 card-hover relative"
                     :class="{ 'border-accent-primary/30': model.is_installed }">
                    <!-- Status Badge -->
                    <div class="preset-badge absolute top-3 right-3 text-xs font-semibold px-2.5 py-1 rounded-full"
                         :class="model.is_installed ? 'bg-accent-success/15 text-accent-success' : 'bg-accent-info/15 text-accent-info'">
                        <span x-text="model.is_installed ? 'Installed' : 'Available'"></span>
                    </div>

                    <!-- Model Info -->
                    <div class="preset-title text-base font-semibold mb-2 pr-14" x-text="model.name"></div>
                    <div class="preset-description text-text-secondary text-sm leading-relaxed mb-3 min-h-10"
                         x-text="model.description || model.use_case || 'No description available'"></div>

                    <!-- Model Meta -->
                    <div class="preset-meta flex gap-4 mb-3 text-xs text-text-tertiary">
                        <div class="preset-meta-item flex items-center gap-1">
                            <span>◉</span>
                            <span x-text="model.download_size || 'Unknown'"></span>
                        </div>
                        <div class="preset-meta-item flex items-center gap-1" x-show="model.category">
                            <span>◈</span>
                            <span x-text="model.category"></span>
                        </div>
                        <div class="preset-meta-item flex items-center gap-1" x-show="model.type">
                            <span>⚡</span>
                            <span x-text="model.type.toUpperCase()"></span>
                        </div>
                    </div>

                    <!-- Download Progress (shown when downloading) -->
                    <template x-if="downloadingModels[model.id]">
                        <div class="mb-3">
                            <div class="progress h-2 bg-bg-tertiary rounded-full overflow-hidden mb-2">
                                <div class="progress-bar-animated h-full bg-gradient-to-r from-accent-primary to-accent-secondary rounded-full transition-all duration-300"
                                     :style="`width: ${downloadingModels[model.id].progress || 0}%`"></div>
                            </div>
                            <div class="flex justify-between text-xs text-text-tertiary">
                                <span x-text="downloadingModels[model.id].status || 'Downloading...'"></span>
                                <span x-text="`${(downloadingModels[model.id].progress || 0).toFixed(0)}%`"></span>
                            </div>
                        </div>
                    </template>

                    <!-- Actions -->
                    <div class="preset-actions flex gap-2">
                        <!-- Installed: Show Generate button -->
                        <template x-if="model.is_installed && !downloadingModels[model.id]">
                            <div class="flex gap-2 w-full">
                                <button class="btn btn-secondary flex-1 py-2 px-3 rounded-md text-sm font-medium border border-border-medium hover:bg-bg-hover hover:border-border-strong transition-all"
                                        @click="showDetails(model)">
                                    Details
                                </button>
                                <a :href="`/generate?model=${model.id}`"
                                   class="btn btn-primary flex-1 py-2 px-3 rounded-md text-sm font-medium bg-accent-primary text-text-inverse shadow-glow hover:bg-orange-600 transition-all text-center">
                                    Generate
                                </a>
                            </div>
                        </template>

                        <!-- Available: Show Install button -->
                        <template x-if="!model.is_installed && !downloadingModels[model.id]">
                            <div class="flex gap-2 w-full">
                                <button class="btn btn-secondary flex-1 py-2 px-3 rounded-md text-sm font-medium border border-border-medium hover:bg-bg-hover hover:border-border-strong transition-all"
                                        @click="showDetails(model)">
                                    Details
                                </button>
                                <button class="btn btn-primary flex-1 py-2 px-3 rounded-md text-sm font-medium bg-accent-primary text-text-inverse shadow-glow hover:bg-orange-600 transition-all"
                                        @click="installModel(model)"
                                        :disabled="installing[model.id]">
                                    <span x-show="!installing[model.id]">Install</span>
                                    <span x-show="installing[model.id]" class="animate-spin">⟳</span>
                                </button>
                            </div>
                        </template>

                        <!-- Downloading: Show Pause/Cancel -->
                        <template x-if="downloadingModels[model.id]">
                            <div class="flex gap-2 w-full">
                                <button class="btn btn-secondary flex-1 py-2 px-3 rounded-md text-sm font-medium border border-border-medium hover:bg-bg-hover hover:border-border-strong transition-all"
                                        @click="pauseDownload(model.id)"
                                        x-show="downloadingModels[model.id].status !== 'paused'">
                                    Pause
                                </button>
                                <button class="btn btn-secondary flex-1 py-2 px-3 rounded-md text-sm font-medium border border-border-medium hover:bg-bg-hover hover:border-border-strong transition-all"
                                        @click="resumeDownload(model.id)"
                                        x-show="downloadingModels[model.id].status === 'paused'">
                                    Resume
                                </button>
                                <button class="btn bg-bg-tertiary text-text-secondary flex-1 py-2 px-3 rounded-md text-sm font-medium hover:bg-bg-hover transition-all"
                                        @click="cancelDownload(model.id)">
                                    Cancel
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && models.length === 0" class="bg-bg-secondary border border-border-subtle rounded-lg p-12 text-center">
            <div class="text-4xl mb-4">◌</div>
            <h3 class="text-lg font-semibold mb-2">No models installed yet</h3>
            <p class="text-text-secondary text-sm mb-6">Get started by browsing and installing model presets</p>
            <a href="/models" class="btn btn-primary py-2.5 px-5 rounded-md text-sm font-medium bg-accent-primary text-text-inverse shadow-glow hover:bg-orange-600 transition-all inline-block">
                Browse Models
            </a>
        </div>
    </section>

    <!-- Recent Activity -->
    <section class="mb-8" x-data="activityFeed()" x-init="loadActivity()">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Recent Activity</h2>
            <button @click="clearActivity()"
                    x-show="activities.length > 0"
                    class="text-accent-primary text-sm font-medium hover:text-accent-secondary transition-colors">
                Clear All
            </button>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="flex flex-col gap-2">
            <template x-for="i in 3" :key="i">
                <div class="activity-item flex items-center gap-4 p-3 bg-bg-secondary border border-border-subtle rounded-md animate-pulse">
                    <div class="w-10 h-10 rounded-md bg-bg-tertiary"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-bg-tertiary rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-bg-tertiary rounded w-1/2"></div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Activity List -->
        <div x-show="!loading && activities.length > 0" class="flex flex-col gap-2">
            <template x-for="activity in activities" :key="activity.id">
                <a :href="activity.link !== '#' ? activity.link : 'javascript:void(0)'"
                   class="activity-item flex items-center gap-4 p-3 bg-bg-secondary border border-border-subtle rounded-md hover:bg-bg-hover transition-colors">
                    <div class="activity-icon w-10 h-10 rounded-md flex items-center justify-center flex-shrink-0"
                         :class="getActivityIconBg(activity)">
                        <span x-text="getActivityIcon(activity)"></span>
                    </div>
                    <div class="activity-content flex-1 min-w-0">
                        <div class="activity-title text-sm font-medium mb-0.5" x-text="activity.title"></div>
                        <div class="activity-meta text-xs text-text-tertiary" x-text="activity.subtitle + ' • ' + formatTime(activity.timestamp)"></div>
                    </div>
                    <div class="activity-status px-2.5 py-1 rounded-full text-xs font-semibold flex-shrink-0"
                         :class="getActivityStatusClass(activity.status)">
                        <span x-text="capitalize(activity.status)"></span>
                    </div>
                </a>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && activities.length === 0" class="bg-bg-secondary border border-border-subtle rounded-lg p-8 text-center">
            <div class="text-4xl mb-4 text-text-tertiary">◌</div>
            <h3 class="text-lg font-semibold mb-2">No recent activity</h3>
            <p class="text-text-secondary text-sm">Activity from generations and downloads will appear here</p>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function recentModels() {
    return {
        models: [],
        loading: true,
        installing: {},
        downloadingModels: {},
        ws: null,

        async loadModels() {
            this.loading = true;
            try {
                const response = await fetch('/api/presets/?limit=6');
                if (response.ok) {
                    const data = await response.json();
                    // Sort: installed models first (up to 3), then fill with available
                    const installed = (data.presets || []).filter(p => p.is_installed).slice(0, 3);
                    const available = (data.presets || []).filter(p => !p.is_installed);
                    const remaining = 6 - installed.length;
                    this.models = [...installed, ...available.slice(0, remaining)];
                }
            } catch (error) {
                console.error('Failed to load models:', error);
            } finally {
                this.loading = false;
            }

            // Connect to WebSocket for real-time updates
            this.connectWebSocket();
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;

            try {
                this.ws = new WebSocket(wsUrl);

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('Failed to parse WebSocket message:', e);
                    }
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
            }
        },

        handleWebSocketMessage(data) {
            if (data.type === 'download_progress') {
                const presetId = data.preset_id;
                this.downloadingModels[presetId] = {
                    progress: data.data?.progress || 0,
                    status: data.data?.status || 'downloading',
                    file: data.data?.file
                };
            } else if (data.type === 'download_complete') {
                const presetId = data.preset_id;
                delete this.downloadingModels[presetId];
                // Reload models to update installed status
                this.loadModels();
            } else if (data.type === 'download_cancelled') {
                const presetId = data.preset_id;
                delete this.downloadingModels[presetId];
            }
        },

        async installModel(model) {
            this.installing[model.id] = true;
            try {
                const response = await fetch(`/api/presets/${model.id}/install`, { method: 'POST' });
                if (response.ok) {
                    // Mark as downloading
                    this.downloadingModels[model.id] = { progress: 0, status: 'starting' };
                } else {
                    const error = await response.json();
                    console.error('Failed to install model:', error);
                    alert(error.detail || 'Failed to start installation');
                }
            } catch (error) {
                console.error('Failed to install model:', error);
                alert('Failed to start installation');
            } finally {
                this.installing[model.id] = false;
            }
        },

        async pauseDownload(presetId) {
            try {
                await fetch(`/api/presets/${presetId}/pause`, { method: 'POST' });
                if (this.downloadingModels[presetId]) {
                    this.downloadingModels[presetId].status = 'paused';
                }
            } catch (error) {
                console.error('Failed to pause download:', error);
            }
        },

        async resumeDownload(presetId) {
            try {
                await fetch(`/api/presets/${presetId}/resume`, { method: 'POST' });
                if (this.downloadingModels[presetId]) {
                    this.downloadingModels[presetId].status = 'downloading';
                }
            } catch (error) {
                console.error('Failed to resume download:', error);
            }
        },

        async cancelDownload(presetId) {
            try {
                await fetch(`/api/presets/${presetId}/cancel`, { method: 'POST' });
                delete this.downloadingModels[presetId];
            } catch (error) {
                console.error('Failed to cancel download:', error);
            }
        },

        showDetails(model) {
            // For now, navigate to models page with model selected
            // Could be enhanced to show a modal in the future
            window.location.href = `/models?model=${model.id}`;
        }
    };
}

function homeDashboard() {
    return {
        stats: {
            totalGenerations: 0,
            modelsInstalled: 0,
            storageUsed: '0 GB',
            activeWorkflows: 0
        },

        initHomeDashboard() {
            // Load stats from API
            this.loadStats();

            // Listen for system status updates
            window.addEventListener('system-status', (e) => {
                this.updateResources(e.detail);
            });
        },

        async loadStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                if (response.ok) {
                    const data = await response.json();
                    this.stats = { ...this.stats, ...data };
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        },

        updateResources(data) {
            // Update resource displays
            console.log('Resources updated:', data);
        }
    }
}

function systemResources() {
    return {
        // Resource data
        memory: { used: 0, total: 0, percent: 0 },
        disk: { used: 0, total: 0, percent: 0 },
        gpuMemory: { used: 0, total: 0, percent: 0 },
        gpuUtilization: 0,
        gpuName: 'GPU',

        // State
        hasGPU: false,
        loading: false,
        lastUpdated: '',
        refreshInterval: null,

        async initResources() {
            // Initial load
            await this.refreshResources();

            // Auto-refresh every 10 seconds
            this.refreshInterval = setInterval(() => this.refreshResources(), 10000);
        },

        async refreshResources() {
            if (this.loading) return;

            this.loading = true;
            try {
                const response = await fetch('/api/system/resources');
                if (response.ok) {
                    const data = await response.json();
                    this.updateResources(data);
                    this.lastUpdated = `Updated ${new Date().toLocaleTimeString()}`;
                }
            } catch (error) {
                console.error('Failed to fetch system resources:', error);
            } finally {
                this.loading = false;
            }
        },

        updateResources(data) {
            // Update memory
            this.memory = {
                used: data.memory.used,
                total: data.memory.total,
                percent: data.memory.percent
            };

            // Update disk
            this.disk = {
                used: data.disk.used,
                total: data.disk.total,
                percent: data.disk.percent
            };

            // Update GPU info if available
            if (data.gpu && data.gpu.devices && data.gpu.devices.length > 0) {
                const gpu = data.gpu.devices[0];
                this.hasGPU = true;
                this.gpuName = gpu.name;
                this.gpuMemory = {
                    used: gpu.memory_used * 1024 * 1024, // Convert MB to bytes
                    total: gpu.memory_total * 1024 * 1024,
                    percent: gpu.memory_total > 0 ? (gpu.memory_used / gpu.memory_total) * 100 : 0
                };
                this.gpuUtilization = gpu.utilization;
            } else {
                this.hasGPU = false;
            }
        },

        formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        },

        getStatusColor(percent) {
            if (percent < 70) return 'text-accent-success';
            if (percent < 90) return 'text-accent-warning';
            return 'text-accent-error';
        },

        getStatusLabel(percent) {
            if (percent < 70) return 'Optimal';
            if (percent < 90) return 'Moderate';
            return 'Critical';
        },

        getBarColor(percent) {
            if (percent < 70) return 'bg-gradient-to-r from-accent-success to-accent-success';
            if (percent < 90) return 'bg-gradient-to-r from-accent-warning to-accent-warning';
            return 'bg-gradient-to-r from-accent-error to-accent-error';
        }
    }
}

function activityFeed() {
    return {
        activities: [],
        loading: true,
        ws: null,

        async loadActivity() {
            this.loading = true;
            try {
                const response = await fetch('/api/activity/recent?limit=5');
                if (response.ok) {
                    const data = await response.json();
                    this.activities = data.activities || [];
                }
            } catch (error) {
                console.error('Failed to load activity:', error);
            } finally {
                this.loading = false;
            }

            // Connect WebSocket for real-time updates
            this.connectWebSocket();
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;

            try {
                this.ws = new WebSocket(wsUrl);

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'new_activity' && data.activity) {
                            // Add new activity at the beginning
                            this.activities.unshift(data.activity);
                            // Keep only 5 items
                            if (this.activities.length > 5) {
                                this.activities.pop();
                            }
                        } else if (data.type === 'download_progress' && data.preset_id) {
                            // Update existing download activity or add new one
                            const existingIdx = this.activities.findIndex(
                                a => a.type === 'download' && a.id.includes(data.preset_id)
                            );
                            if (existingIdx >= 0) {
                                this.activities[existingIdx].subtitle = `${Math.round(data.data?.progress || 0)}% complete`;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to parse WebSocket message:', e);
                    }
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
            }
        },

        async clearActivity() {
            try {
                const response = await fetch('/api/activity/clear', { method: 'DELETE' });
                if (response.ok) {
                    this.activities = [];
                }
            } catch (error) {
                console.error('Failed to clear activity:', error);
            }
        },

        getActivityIconBg(activity) {
            if (activity.status === 'failed') return 'bg-accent-error/15';
            if (activity.type === 'download') return 'bg-accent-primary/15';
            return 'bg-accent-success/15';
        },

        getActivityIcon(activity) {
            if (activity.status === 'failed') return '✕';
            if (activity.type === 'download') return '↓';
            return '✓';
        },

        getActivityStatusClass(status) {
            if (status === 'completed') return 'bg-accent-success/15 text-accent-success';
            if (status === 'failed') return 'bg-accent-error/15 text-accent-error';
            if (status === 'started') return 'bg-accent-primary/15 text-accent-primary';
            return 'bg-accent-info/15 text-accent-info';
        },

        formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000;

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
            if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
            return Math.floor(diff / 86400) + ' days ago';
        },

        capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    }
}

function downloadQueue() {
    return {
        currentDownload: null,
        queuedDownloads: [],
        hasActiveDownloads: false,
        ws: null,
        reconnectAttempts: 0,
        maxReconnectAttempts: 5,

        get hasActiveDownloads() {
            return this.currentDownload !== null || this.queuedDownloads.length > 0;
        },

        async initQueue() {
            // Load initial queue status
            await this.refreshQueue();

            // Connect to WebSocket for real-time updates
            this.connectWebSocket();

            // Poll for updates as fallback
            setInterval(() => this.refreshQueue(), 10000);
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/downloads`;

            try {
                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('Download queue WebSocket connected');
                    this.reconnectAttempts = 0;
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('Failed to parse WebSocket message:', e);
                    }
                };

                this.ws.onclose = () => {
                    console.log('Download queue WebSocket disconnected');
                    this.attemptReconnect();
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                this.attemptReconnect();
            }
        },

        attemptReconnect() {
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                this.reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                setTimeout(() => this.connectWebSocket(), delay);
            }
        },

        handleWebSocketMessage(data) {
            if (data.type === 'download_progress') {
                // Update current download progress
                this.currentDownload = {
                    preset_id: data.preset_id,
                    name: data.preset_id, // Could be enhanced to show friendly name
                    file: data.data.file,
                    progress: data.data.progress,
                    downloaded: data.data.downloaded,
                    total: data.data.total,
                    status: data.data.status,
                    eta: this.calculateETA(data.data)
                };
            } else if (data.type === 'queue_updated') {
                // Update queue state
                this.currentDownload = data.current ? {
                    preset_id: data.current,
                    name: data.current,
                    progress: 0,
                    status: 'downloading'
                } : null;

                // Update queued items
                this.queuedDownloads = data.queue.map(preset_id => ({
                    preset_id: preset_id,
                    name: preset_id
                }));
            }
        },

        async refreshQueue() {
            try {
                const response = await fetch('/api/presets/queue/status');
                if (response.ok) {
                    const data = await response.json();

                    // Update current download
                    if (data.current) {
                        this.currentDownload = {
                            preset_id: data.current,
                            name: data.current,
                            progress: 0,
                            status: 'downloading'
                        };

                        // Get detailed status for current download
                        const statusResponse = await fetch(`/api/presets/${data.current}/status`);
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            if (statusData.download_status && statusData.download_status.files) {
                                const downloadingFile = statusData.download_status.files.find(
                                    f => f.status === 'downloading'
                                );
                                if (downloadingFile) {
                                    this.currentDownload.file = downloadingFile.path;
                                    this.currentDownload.progress = downloadingFile.progress;
                                }
                            }
                        }
                    } else {
                        this.currentDownload = null;
                    }

                    // Update queued downloads
                    this.queuedDownloads = data.queue.map(preset_id => ({
                        preset_id: preset_id,
                        name: preset_id
                    }));
                }
            } catch (error) {
                console.error('Failed to refresh queue:', error);
            }
        },

        formatProgress(download) {
            if (!download) return '';

            const progress = download.progress || 0;
            const downloaded = this.formatBytes(download.downloaded || 0);
            const total = this.formatBytes(download.total || 0);

            return `${progress.toFixed(1)}% (${downloaded} / ${total})`;
        },

        formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        },

        calculateETA(data) {
            if (!data || !data.downloaded || !data.total || data.progress < 1) {
                return null;
            }

            // Simple ETA calculation (would need start time for accurate calculation)
            const remaining = data.total - data.downloaded;
            // Assuming average speed, this is a placeholder
            return 'Calculating...';
        },

        async pauseDownload(presetId) {
            try {
                const response = await fetch(`/api/presets/${presetId}/pause`, { method: 'POST' });
                if (response.ok && this.currentDownload) {
                    this.currentDownload.status = 'paused';
                }
            } catch (error) {
                console.error('Failed to pause download:', error);
            }
        },

        async resumeDownload(presetId) {
            try {
                const response = await fetch(`/api/presets/${presetId}/resume`, { method: 'POST' });
                if (response.ok && this.currentDownload) {
                    this.currentDownload.status = 'downloading';
                }
            } catch (error) {
                console.error('Failed to resume download:', error);
            }
        },

        async cancelDownload(presetId) {
            try {
                const response = await fetch(`/api/presets/${presetId}/cancel`, { method: 'POST' });
                if (response.ok) {
                    this.currentDownload = null;
                    await this.refreshQueue();
                }
            } catch (error) {
                console.error('Failed to cancel download:', error);
            }
        },

        async removeFromQueue(presetId) {
            // Cancel the queued download
            await this.cancelDownload(presetId);
        }
    }
}
</script>
{% endblock %}
