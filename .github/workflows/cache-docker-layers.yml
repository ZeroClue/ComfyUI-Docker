name: Cache Docker Layers for Optimized Builds

on:
  workflow_dispatch:
  push:
    branches: [main, feature/runpod-startup-optimization]
    paths:
      - 'Dockerfile'
      - 'Dockerfile.single-stage'
      - 'docker-bake.hcl'
      - 'docker-bake-single-stage.hcl'
      - 'scripts/**'
      - 'config/**'
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'Dockerfile.single-stage'
      - 'docker-bake.hcl'
      - 'docker-bake-single-stage.hcl'
      - 'scripts/**'
      - 'config/**'

env:
  DOCKER_REPO: zeroclue/comfyui
  PYTHON_VERSION: "3.13"
  TORCH_VERSION: "2.8.0"

jobs:
  # Cache builder layers for faster subsequent builds
  cache-layers:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cuda_version: [12-6, 12-8]
        variant: [base-optimized, production-optimized]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      - name: Generate cache key
        id: cache-key
        run: |
          # Generate a unique cache key based on content hash
          CACHE_KEY="docker-cache-${{ matrix.variant }}-${{ matrix.cuda_version }}-$(git rev-parse --short HEAD)"
          echo "cache-key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "restore-keys=docker-cache-${{ matrix.variant }}-${{ matrix.cuda_version }}-" >> $GITHUB_OUTPUT

      - name: Try to restore cache
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ steps.cache-key.outputs.cache-key }}
          restore-keys: ${{ steps.cache-key.outputs.restore-keys }}
          fail-on-cache-miss: false

      - name: Build with cache
        if: steps.cache.outputs.cache-hit == 'true'
        run: |
          echo "ðŸš€ Using cached layers for ${{ matrix.variant }}-${{ matrix.cuda_version }}"
          docker buildx bake \
            -f docker-bake.hcl \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            ${{ matrix.variant }}-${{ matrix.cuda_version }}

      - name: Build without cache
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ”¨ Building fresh layers for ${{ matrix.variant }}-${{ matrix.cuda_version }}"
          docker buildx bake \
            -f docker-bake.hcl \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            ${{ matrix.variant }}-${{ matrix.cuda_version }}

      - name: Save cache
        if: always()
        run: |
          # Move cache to final location
          rm -rf /tmp/.buildx-cache || true
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

  # Pre-build common layers for maximum cache reuse
  prebuild-common-layers:
    runs-on: ubuntu-latest
    needs: cache-layers
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Extract and cache base layers
        run: |
          echo "ðŸ—ï¸  Pre-building common base layers..."

          # Build just the base system layers
          docker buildx build \
            --target base \
            -f Dockerfile \
            --cache-from type=gha,scope=base \
            --cache-to type=gha,scope=base,mode=max \
            --load \
            .

      - name: Extract and cache Python layers
        run: |
          echo "ðŸ Pre-building Python layers..."

          # Build Python installation layers
          docker buildx build \
            --target python-setup \
            -f Dockerfile \
            --cache-from type=gha,scope=python \
            --cache-to type=gha,scope=python,mode=max \
            --load \
            .

  # Validate cache effectiveness
  validate-cache:
    runs-on: ubuntu-latest
    needs: [cache-layers, prebuild-common-layers]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test cache effectiveness
        run: |
          echo "ðŸ“Š Testing cache effectiveness..."

          # Time a cached build
          START_TIME=$(date +%s)
          docker buildx build \
            --target base \
            -f Dockerfile \
            --cache-from type=gha,scope=base \
            --load \
            .
          END_TIME=$(date +%s)

          CACHED_TIME=$((END_TIME - START_TIME))
          echo "Cached build time: ${CACHED_TIME}s"

          # Save timing metrics
          echo "cached_build_time=${CACHED_TIME}" >> $GITHUB_ENV

      - name: Cache Performance Report
        run: |
          echo "## Cache Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Cached build time: ${{ env.cached_build_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Cache scope: base and python layers" >> $GITHUB_STEP_SUMMARY
          echo "- Expected improvement: 40-60% faster builds" >> $GITHUB_STEP_SUMMARY

  # Clean up old caches
  cleanup-caches:
    runs-on: ubuntu-latest
    needs: validate-cache
    if: always()
    steps:
      - name: Clean old caches
        uses: actions/github-script@v6
        with:
          script: |
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // Keep only the 10 most recent caches
            const recentCaches = caches.data.actions_caches
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(10);

            for (const cache of recentCaches) {
              console.log(`Deleting cache: ${cache.key}`);
              await github.rest.actions.deleteActionsCache({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id,
              });
            }

            console.log(`Cleaned up ${recentCaches.length} old caches`);