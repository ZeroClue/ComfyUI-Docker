# Workflow Preset Suggestions Design

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:writing-plans to create implementation plan.

**Goal:** When a user selects a workflow, suggest presets that provide the required models, enabling one-click installation of all dependencies.

**Architecture:** Hybrid approach - bot-generated model_index.json maps filenames to preset IDs, dashboard caches and looks up mappings at runtime, UI shows install buttons for missing presets.

**Tech Stack:** Python, FastAPI, Alpine.js, existing preset registry system

---

## Problem Statement

User workflows (from `/workspace/workflows` or ComfyUI's user directory) extract model filenames like `flux-dev.safetensors` but have no way to know which preset provides them. Users see "3 models needed" but no path to install them.

Library workflows (from registry) have `required_presets` with install buttons, but user workflows are left with a manual download burden.

## Solution: Model-to-Preset Mapping

Add a reverse index that maps model filenames to preset IDs:

1. **Generation time**: Preset bot in `comfyui-presets` repo builds `model_index.json`
2. **Sync time**: Dashboard pulls both `registry.json` and `model_index.json`
3. **Runtime**: WorkflowScanner looks up each required model → suggests preset

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│              COMFYUI-PRESETS REPO (Bot-Generated)               │
├─────────────────────────────────────────────────────────────────┤
│  registry.json          # Preset metadata (exists)              │
│  model_index.json       # NEW: filename → preset_id mapping     │
└─────────────────────────────────────────────────────────────────┘
                    │
                    │ HTTP GET (on /registry/sync)
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DASHBOARD (/workspace/data/)               │
├─────────────────────────────────────────────────────────────────┤
│  registry.json          # Cached preset data                    │
│  model_index.json       # Cached model → preset mapping         │
│                                                                  │
│  WorkflowScanner:                                                │
│  ├── scan_workflow() extracts required_models (filenames)       │
│  ├── resolve_model_to_preset() maps filename → preset           │
│  └── Returns suggested_presets[] with install status            │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                         GENERATE PAGE UI                        │
├─────────────────────────────────────────────────────────────────┤
│  User Workflow Card:                                             │
│  ├── "3 models needed" badge                                     │
│  ├── Expand → shows each model + suggested preset               │
│  │   ├── ✓ flux-dev.safetensors (installed)                     │
│  │   ├── ⚠ t5xxl_fp16.safetensors → FLUX_T5_ENCODER preset     │
│  │   └── ⚠ ae.safetensors → FLUX_VAE preset                    │
│  └── [Install Missing & Generate] button                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## Data Structures

### model_index.json (Generated by preset bot)

```json
{
  "version": "1.0.0",
  "generated_at": "2026-02-22T00:00:00Z",
  "mappings": {
    "checkpoints/flux-dev.safetensors": "FLUX_DEV",
    "checkpoints/flux-schnell.safetensors": "FLUX_SCHNELL",
    "text_encoders/t5xxl_fp16.safetensors": "T5_XXL_ENCODER",
    "text_encoders/t5xxl_fp8_e4m3fn.safetensors": "T5_XXL_ENCODER_FP8",
    "vae/ae.safetensors": "FLUX_VAE",
    "vae/sdxl_vae.safetensors": "SDXL_VAE",
    "checkpoints/wan2.5_t2v_14B.safetensors": "WAN_22_5B_TIV2"
  },
  "unmapped": [
    "custom_model.safetensors"
  ]
}
```

**Key design decisions:**
- **Path-relative keys**: `checkpoints/flux-dev.safetensors` not just `flux-dev.safetensors`
- **Preset ID values**: Maps to existing preset IDs in registry
- **One-to-many handled**: Multiple paths can map to same preset
- **Unmapped array**: Tracks models the bot couldn't assign

### Enhanced Workflow Metadata (API response)

```json
{
  "id": "my-flux-workflow",
  "name": "My FLUX Workflow",
  "required_models": ["flux-dev.safetensors", "t5xxl_fp16.safetensors"],
  "suggested_presets": [
    {
      "model_file": "flux-dev.safetensors",
      "preset_id": "FLUX_DEV",
      "preset_name": "FLUX Dev",
      "installed": false,
      "download_size": "23.5GB"
    },
    {
      "model_file": "t5xxl_fp16.safetensors",
      "preset_id": "T5_XXL_ENCODER",
      "preset_name": "T5-XXL Text Encoder",
      "installed": true,
      "download_size": "4.9GB"
    }
  ],
  "unmapped_models": [],
  "model_status": {"total": 2, "installed": 1, "missing": 1},
  "ready": false
}
```

---

## Backend Changes

### 1. Enhanced Registry Sync Endpoint

```python
# dashboard/api/presets.py

@router.post("/registry/sync")
async def sync_registry():
    """Pull latest registry.json and model_index.json from GitHub"""

    # Download registry.json (existing)
    registry_url = "https://raw.githubusercontent.com/ZeroClue/comfyui-presets/main/registry.json"
    registry_data = await fetch_github_json(registry_url)

    # Download model_index.json (new)
    index_url = "https://raw.githubusercontent.com/ZeroClue/comfyui-presets/main/model_index.json"
    index_data = await fetch_github_json(index_url)

    # Save both to /workspace/data/
    save_json("/workspace/data/registry.json", registry_data)
    save_json("/workspace/data/model_index.json", index_data)

    return {"status": "synced", "presets": len(registry_data.get("presets", {}))}
```

### 2. New WorkflowScanner Method

```python
# dashboard/core/workflow_scanner.py

def __init__(self, ...):
    # ... existing init ...
    self._model_index_path = Path("/workspace/data/model_index.json")
    self._model_index: Dict[str, str] = {}
    self._load_model_index()

def _load_model_index(self):
    """Load model → preset mapping from cache."""
    if self._model_index_path.exists():
        with open(self._model_index_path) as f:
            data = json.load(f)
            self._model_index = data.get("mappings", {})

def resolve_model_to_preset(self, model_filename: str) -> Optional[Dict]:
    """
    Find which preset provides a given model file.
    Returns preset info or None if not found in any preset.
    """
    # Try exact path match first
    for model_dir in self.MODEL_DIRECTORIES:
        path_key = f"{model_dir}/{model_filename}"
        if path_key in self._model_index:
            return self._get_preset_info(self._model_index[path_key])

    # Fallback: filename-only match
    for path_key, preset_id in self._model_index.items():
        if Path(path_key).name == model_filename:
            return self._get_preset_info(preset_id)

    return None  # Model not in any preset
```

### 3. Enhanced scan_workflow() Return

```python
def scan_workflow(self, workflow_path: Path) -> Dict[str, Any]:
    # ... existing model extraction ...
    required_models = self._extract_required_models(data)

    # NEW: Resolve each model to preset
    suggested_presets = []
    unmapped_models = []
    seen_presets = set()

    for model_file in required_models:
        preset_info = self.resolve_model_to_preset(model_file)
        if preset_info:
            if preset_info["id"] not in seen_presets:
                seen_presets.add(preset_info["id"])
                suggested_presets.append({
                    "model_file": model_file,
                    **preset_info
                })
        else:
            unmapped_models.append(model_file)

    return {
        # ... existing fields ...
        "suggested_presets": suggested_presets,
        "unmapped_models": unmapped_models,
    }
```

---

## Frontend Changes

### 1. User Workflow Card - Missing Models Panel

```html
<!-- Model Requirements Panel (for user/comfyui workflows) -->
<div x-show="selectedWorkflow?.id === workflow.id &&
             workflow.source !== 'library' &&
             workflow.suggested_presets?.length"
     class="mt-3 pt-3 border-t border-border-primary">

    <h4 class="text-sm font-medium text-text-secondary mb-2">Required Models</h4>

    <!-- Suggested Presets -->
    <template x-for="preset in workflow.suggested_presets" :key="preset.preset_id">
        <div class="flex items-center justify-between py-1.5">
            <div class="flex items-center gap-2">
                <span x-show="preset.installed" class="text-accent-success">✓</span>
                <span x-show="!preset.installed" class="text-accent-warning">⚠</span>
                <div>
                    <div class="text-sm" x-text="preset.preset_name"></div>
                    <div class="text-xs text-text-tertiary" x-text="preset.model_file"></div>
                </div>
            </div>
            <div>
                <span x-show="preset.installed" class="text-xs text-accent-success">Installed</span>
                <button x-show="!preset.installed"
                        @click.stop="installPreset(preset.preset_id)"
                        class="px-2 py-1 text-xs bg-accent-primary text-white rounded">
                    <span x-text="preset.download_size || 'Install'"></span>
                </button>
            </div>
        </div>
    </template>

    <!-- Unmapped Models -->
    <template x-for="model in workflow.unmapped_models" :key="model">
        <div class="flex items-center justify-between py-1.5 bg-bg-tertiary rounded px-2">
            <div class="flex items-center gap-2">
                <span class="text-accent-warning">?</span>
                <span class="text-sm text-text-secondary" x-text="model"></span>
            </div>
            <span class="text-xs text-text-tertiary">Manual download required</span>
        </div>
    </template>

    <!-- Action Buttons -->
    <div class="mt-4 flex justify-end gap-2">
        <button x-show="hasMissingUserPresets(workflow)"
                @click.stop="installAllUserPresets(workflow)"
                class="px-3 py-1.5 text-sm bg-accent-warning text-white rounded">
            ↓ Install Missing & Generate
        </button>
        <button x-show="workflow.ready"
                @click.stop="selectAndGenerate(workflow)"
                class="px-4 py-2 text-sm bg-accent-primary text-white rounded">
            Generate
        </button>
    </div>
</div>
```

### 2. JavaScript Helpers

```javascript
hasMissingUserPresets(workflow) {
    return workflow.suggested_presets?.some(p => !p.installed);
},

async installAllUserPresets(workflow) {
    const missing = workflow.suggested_presets?.filter(p => !p.installed) || [];
    for (const preset of missing) {
        await fetch('/api/presets/install', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({preset_id: preset.preset_id})
        });
    }
    window.showToast('success', 'Downloads Started', `Installing ${missing.length} presets`);
},
```

---

## Edge Cases

| Scenario | Handling |
|----------|----------|
| model_index.json not synced | Return empty mapping, show "Sync registry for suggestions" |
| Model in multiple presets | Return first match (or smallest download size) |
| Model not in any preset | Add to `unmapped_models`, show "Manual download required" |
| Preset install fails | Existing error handling, toast notification |
| Filename mismatch | Fuzzy match by filename stem, show "Not found" |
| Network volume offline | Model check fails gracefully, assume not installed |
| Partial preset installed | Check all files, only mark complete if all exist |
| User has model but not via preset | File exists check passes, show "Installed" |

---

## Implementation Scope

**Files to modify:**
1. `dashboard/api/presets.py` - Enhanced sync endpoint
2. `dashboard/core/workflow_scanner.py` - Add model resolution
3. `dashboard/templates/generate.html` - UI for preset suggestions

**External dependency:**
- `comfyui-presets` repo needs to generate `model_index.json` (separate task)

**No new database tables** - uses cached JSON files.

---

## Success Criteria

1. User workflow shows suggested presets for missing models
2. "Install Missing & Generate" queues all needed presets
3. Unmapped models show manual download guidance
4. Works for user, ComfyUI, and library workflows uniformly
