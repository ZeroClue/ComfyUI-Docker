{% extends "base.html" %}

{% block title %}Browse Presets - ComfyUI Preset Manager{% endblock %}

{% block page_title %}Browse Presets{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button class="btn btn-outline-secondary" onclick="toggleView()">
            <i class="fas fa-th me-1"></i>Toggle View
        </button>
        <a href="{{ url_for('storage') }}" class="btn btn-outline-primary">
            <i class="fas fa-hdd me-1"></i>Storage Manager
        </a>
    </div>
{% endblock %}

{% block content %}
<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput"
                                   placeholder="Search presets..." onkeyup="filterPresets()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter" onchange="filterPresets()">
                            <option value="">All Categories</option>
                            {% for category_name in categories.keys() %}
                            <option value="{{ category_name }}">{{ category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter" onchange="filterPresets()">
                            <option value="">All Status</option>
                            <option value="installed">Installed</option>
                            <option value="partial">Partially Installed</option>
                            <option value="available">Available</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="sortBy" onchange="sortPresets()">
                            <option value="name">Name</option>
                            <option value="size">Size</option>
                            <option value="status">Status</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preset Categories -->
<div class="row" id="presetsContainer">
    {% for category_name, presets in categories.items() %}
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cube me-2"></i>{{ category_name }}
                    <span class="badge bg-light text-primary float-end">
                        {{ presets|length }} presets
                    </span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="{{ category_name|replace(' ', '-')|lower }}-presets">
                    {% for preset in presets %}
                    <div class="col-lg-4 col-md-6 mb-3 preset-item"
                         data-category="{{ category_name }}"
                         data-name="{{ preset.name|lower }}"
                         data-status="{% if preset.is_installed %}installed{% elif preset.is_partial %}partial{% else %}available{% endif %}"
                         data-size="{{ preset.download_size }}">
                        <div class="card h-100 preset-card">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">{{ preset.name }}</h6>
                                    {% if preset.is_installed %}
                                        <span class="badge bg-success status-badge">
                                            <i class="fas fa-check"></i> Installed
                                        </span>
                                    {% elif preset.is_partial %}
                                        <span class="badge bg-warning status-badge">
                                            <i class="fas fa-exclamation-triangle"></i> Partial
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary status-badge">
                                            <i class="fas fa-download"></i> Available
                                        </span>
                                    {% endif %}
                                </div>

                                <p class="card-text text-muted small">{{ preset.description }}</p>

                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-hdd me-1"></i>{{ preset.download_size }}
                                        <span class="ms-2">
                                            <i class="fas fa-file me-1"></i>{{ preset.files|length }} files
                                        </span>
                                    </small>
                                </div>

                                {% if preset.total_size_gb > 0 %}
                                <div class="mb-2">
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Installed: {{ preset.total_size_gb }}GB
                                    </small>
                                </div>
                                {% endif %}

                                <div class="mt-auto">
                                    <div class="btn-group w-100" role="group">
                                        <button class="btn btn-sm btn-outline-primary flex-fill"
                                                onclick="showPresetDetails('{{ preset.id }}')">
                                            <i class="fas fa-info"></i> Details
                                        </button>
                                        <button class="btn btn-sm {% if preset.is_installed %}btn-outline-danger{% else %}btn-success{% endif %} flex-fill"
                                                onclick="handlePresetAction('{{ preset.id }}', {% if preset.is_installed %}true{% else %}false{% endif %})"
                                                {% if preset.is_partial %}disabled{% endif %}>
                                            {% if preset.is_installed %}
                                                <i class="fas fa-trash"></i> Delete
                                            {% else %}
                                                <i class="fas fa-download"></i> Download
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>

                                {% if preset.is_partial %}
                                <div class="mt-2">
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Partial installation ({{ preset.installed_files|length }}/{{ preset.files|length }} files)
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Preset Details Modal -->
<div class="modal fade" id="presetDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preset Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="presetDetailsContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalActionButton">
                    <!-- Action button based on preset status -->
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this preset and all its files?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This action cannot be undone. All downloaded files will be permanently removed.
                </div>
                <div id="deleteFilesList">
                    <!-- Files list populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Delete Forever
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPresetId = null;
    let viewMode = 'grid'; // 'grid' or 'list'

    // Filter and search functionality
    function filterPresets() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        document.querySelectorAll('.preset-item').forEach(item => {
            const name = item.dataset.name;
            const category = item.dataset.category;
            const status = item.dataset.status;

            const matchesSearch = name.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesStatus = !statusFilter || status === statusFilter;

            if (matchesSearch && matchesCategory && matchesStatus) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Sort presets
    function sortPresets() {
        const sortBy = document.getElementById('sortBy').value;
        const containers = document.querySelectorAll('[id$="-presets"]');

        containers.forEach(container => {
            const items = Array.from(container.querySelectorAll('.preset-item'));

            items.sort((a, b) => {
                let aValue, bValue;

                switch (sortBy) {
                    case 'name':
                        aValue = a.dataset.name;
                        bValue = b.dataset.name;
                        return aValue.localeCompare(bValue);
                    case 'size':
                        aValue = parseFloat(a.dataset.size);
                        bValue = parseFloat(b.dataset.size);
                        return bValue - aValue; // Largest first
                    case 'status':
                        const statusOrder = { 'installed': 0, 'partial': 1, 'available': 2 };
                        aValue = statusOrder[a.dataset.status];
                        bValue = statusOrder[b.dataset.status];
                        return aValue - bValue;
                    default:
                        return 0;
                }
            });

            // Re-append sorted items
            items.forEach(item => container.appendChild(item));
        });
    }

    // Toggle between grid and list view
    function toggleView() {
        const container = document.getElementById('presetsContainer');
        viewMode = viewMode === 'grid' ? 'list' : 'grid';

        document.querySelectorAll('.preset-item').forEach(item => {
            if (viewMode === 'list') {
                item.classList.remove('col-lg-4', 'col-md-6');
                item.classList.add('col-12');
            } else {
                item.classList.remove('col-12');
                item.classList.add('col-lg-4', 'col-md-6');
            }
        });
    }

    // Show preset details
    function showPresetDetails(presetId) {
        currentPresetId = presetId;

        fetch(`/preset/${presetId}`)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('.card-body').innerHTML;

                document.getElementById('presetDetailsContent').innerHTML = content;

                // Update modal action button based on preset status
                updateModalActionButton(doc);

                const modal = new bootstrap.Modal(document.getElementById('presetDetailsModal'));
                modal.show();
            })
            .catch(error => {
                showAlert('Error loading preset details', 'danger');
            });
    }

    // Update modal action button based on preset status
    function updateModalActionButton(doc) {
        const actionButton = document.getElementById('modalActionButton');
        if (!actionButton) return;

        // Check preset status by looking for status badges in the loaded content
        const statusBadge = doc.querySelector('.badge');
        let isInstalled = false;
        let isPartial = false;

        if (statusBadge) {
            if (statusBadge.textContent.includes('Installed')) {
                isInstalled = true;
            } else if (statusBadge.textContent.includes('Partial')) {
                isPartial = true;
            }
        }

        // Remove existing event listeners
        actionButton.replaceWith(actionButton.cloneNode(true));
        const newActionButton = document.getElementById('modalActionButton');

        // Configure button based on preset status
        if (isInstalled) {
            // Preset is installed - show delete button
            newActionButton.textContent = 'Delete Preset';
            newActionButton.className = 'btn btn-danger';
            newActionButton.onclick = function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('presetDetailsModal'));
                modal.hide();
                handlePresetAction(currentPresetId, true);
            };
        } else if (isPartial) {
            // Preset is partially installed - show complete download button
            newActionButton.textContent = 'Complete Download';
            newActionButton.className = 'btn btn-warning';
            newActionButton.onclick = function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('presetDetailsModal'));
                modal.hide();
                handlePresetAction(currentPresetId, false);
            };
        } else {
            // Preset is not installed - show download button
            newActionButton.textContent = 'Download Preset';
            newActionButton.className = 'btn btn-success';
            newActionButton.onclick = function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('presetDetailsModal'));
                modal.hide();
                handlePresetAction(currentPresetId, false);
            };
        }
    }

    // Handle preset download/delete action
    function handlePresetAction(presetId, isInstalled) {
        currentPresetId = presetId;

        if (isInstalled) {
            // Show delete confirmation
            fetch(`/preset/${presetId}`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Extract file list
                    const installedFiles = [];
                    doc.querySelectorAll('[data-file]').forEach(file => {
                        installedFiles.push({
                            name: file.dataset.file,
                            size: file.dataset.size
                        });
                    });

                    if (installedFiles.length > 0) {
                        let filesHtml = '<h6>Files to be deleted:</h6><ul class="list-group">';
                        installedFiles.forEach(file => {
                            filesHtml += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>${file.name}</span>
                                    <span class="badge bg-secondary">${formatBytes(parseInt(file.size))}</span>
                                </li>
                            `;
                        });
                        filesHtml += '</ul>';
                        document.getElementById('deleteFilesList').innerHTML = filesHtml;
                    }

                    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    modal.show();
                });
        } else {
            // Start download
            downloadPreset(presetId);
        }
    }

    // Download preset
    function downloadPreset(presetId) {
        const modal = showOperationModal('Downloading Preset');

        fetch(`/api/download/${presetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                hideOperationModal();
                showAlert(data.error, 'danger');
            } else {
                pollOperationStatus(data.operation_id, function(result) {
                    showAlert(`Successfully downloaded ${presetId}!`, 'success');
                    setTimeout(() => location.reload(), 2000);
                }, function(error) {
                    showAlert(`Download failed: ${error.message}`, 'danger');
                });
            }
        })
        .catch(error => {
            hideOperationModal();
            showAlert('Download failed: ' + error.message, 'danger');
        });
    }

    // Delete preset
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!currentPresetId) return;

        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        modal.hide();

        const operationModal = showOperationModal('Deleting Preset');

        fetch(`/api/delete/${currentPresetId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            hideOperationModal();
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            hideOperationModal();
            showAlert('Delete failed: ' + error.message, 'danger');
        });
    });

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function() {
        // Add tooltips to preset cards
        document.querySelectorAll('.preset-card').forEach(card => {
            card.setAttribute('data-bs-toggle', 'tooltip');
            card.setAttribute('data-bs-placement', 'top');
            card.setAttribute('title', 'Click to view details');
        });
    });
</script>
{% endblock %}