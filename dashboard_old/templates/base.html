<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ComfyUI-Docker Dashboard{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>

    <!-- Tailwind configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        accent: {
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Fade transition */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    {% block content %}{% endblock %}

    <!-- WebSocket connection status -->
    <div id="ws-status" x-data="{ connected: false }" x-show="!connected"
         x-init="setTimeout(() => connected = true, 5000)"
         class="fixed top-4 right-4 bg-yellow-500/20 border border-yellow-500/50 text-yellow-200 px-4 py-2 rounded-lg text-sm z-50"
         style="display: none;">
        Connecting to real-time updates...
    </div>

    <script>
        // WebSocket connection for real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            const wsStatus = document.getElementById('ws-status');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = function() {
                console.log('WebSocket connected');
                if (wsStatus) wsStatus.style.display = 'none';
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');
                if (wsStatus) wsStatus.style.display = 'block';
                // Reconnect after 5 seconds
                setTimeout(function() {
                    location.reload();
                }, 5000);
            };

            function handleWebSocketMessage(data) {
                switch(data.type) {
                    case 'preset_progress':
                        updatePresetProgress(data.data);
                        break;
                    case 'download_started':
                        showNotification(`Download started: ${data.preset_id}`, 'info');
                        break;
                    case 'connected':
                        console.log('WebSocket connection established');
                        break;
                }
            }

            function updatePresetProgress(progress) {
                // Update progress bars if they exist
                for (const [presetId, data] of Object.entries(progress)) {
                    const progressBar = document.getElementById(`progress-${presetId}`);
                    if (progressBar) {
                        const percent = (data.completed_files / data.total_files) * 100;
                        progressBar.style.width = `${percent}%`;
                    }
                }
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-primary-500'
                }`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        });
    </script>
</body>
</html>
