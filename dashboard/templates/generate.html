{% extends "base.html" %}

{% block title %}Generate - ComfyUI Dashboard{% endblock %}

{% block page_breadcrumb %}
<span class="text-text-primary font-medium">Generate</span>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col" x-data="generatePage()" x-init="initGeneratePage()">
    <!-- Quick Intent Bar (Collapsible) -->
    <div class="border-b border-border-subtle bg-bg-secondary">
        <button class="w-full px-6 py-3 flex items-center justify-between text-left hover:bg-bg-hover transition-colors"
                @click="intentBarExpanded = !intentBarExpanded">
            <div class="flex items-center gap-3">
                <span class="text-lg">üí≠</span>
                <span class="font-medium">Quick Intent</span>
                <span class="text-text-secondary text-sm" x-show="!intentBarExpanded && lastIntent">
                    <span x-text="lastIntent"></span>
                </span>
            </div>
            <span class="text-text-tertiary transition-transform" :class="{ 'rotate-180': intentBarExpanded }">‚ñº</span>
        </button>

        <!-- Intent Bar Content -->
        <div x-show="intentBarExpanded" class="px-6 pb-4" style="display: none;">
            <div class="text-sm text-text-secondary mb-3">I want to...</div>
            <div class="flex flex-wrap gap-2">
                <template x-for="action in quickActions" :key="action.id">
                    <button class="px-4 py-2 rounded-md text-sm font-medium border transition-all"
                            :class="selectedIntent === action.id ? 'bg-accent-primary/15 border-accent-primary text-accent-primary' : 'bg-bg-tertiary border-border-subtle text-text-secondary hover:border-border-medium'"
                            @click="selectIntent(action.id)">
                        <span x-text="action.icon" class="mr-1"></span>
                        <span x-text="action.label"></span>
                    </button>
                </template>
            </div>

            <!-- Custom Intent Input -->
            <div class="mt-3 flex gap-2">
                <input type="text"
                       x-model="customIntent"
                       placeholder="Or describe what you want to create..."
                       class="flex-1 px-4 py-2 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-primary placeholder-text-tertiary focus:outline-none focus:border-accent-primary focus:ring-1 focus:ring-accent-primary transition-all"
                       @keyup.enter="matchIntent">
                <button class="px-4 py-2 rounded-md text-sm font-medium bg-accent-primary text-text-inverse hover:bg-orange-600 transition-all"
                        @click="matchIntent"
                        :disabled="!customIntent.trim()">
                    Match
                </button>
            </div>

            <!-- Intent Match Result -->
            <div x-show="intentResult && intentResult.matched" class="mt-3 p-3 bg-accent-success/10 border border-accent-success/30 rounded-md">
                <div class="text-sm text-accent-success font-medium">
                    Matched: <span x-text="intentResult?.matched_keyword || ''"></span>
                </div>
                <div class="text-xs text-text-secondary mt-1">
                    <template x-for="suggestion in (intentResult?.suggestions || [])" :key="suggestion">
                        <div x-text="suggestion"></div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel: Workflow Browser (~40%) -->
        <div class="w-2/5 border-r border-border-subtle flex flex-col bg-bg-primary">
            <!-- Workflow Browser Header -->
            <div class="p-4 border-b border-border-subtle">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">Workflows</h2>
                    <span class="text-sm text-text-tertiary" x-text="`${filteredWorkflows.length} available`"></span>
                </div>

                <!-- Search -->
                <div class="relative mb-3">
                    <input type="text"
                           x-model="searchQuery"
                           placeholder="Search workflows..."
                           class="w-full px-4 py-2 pl-10 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-primary placeholder-text-tertiary focus:outline-none focus:border-accent-primary focus:ring-1 focus:ring-accent-primary transition-all">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-tertiary">‚óâ</span>
                </div>

                <!-- Source Filters -->
                <div class="flex gap-2 mb-3">
                    <button class="px-3 py-1.5 rounded-md text-xs font-medium transition-all"
                            :class="sourceFilter === 'all' ? 'bg-accent-primary text-white' : 'bg-bg-tertiary text-text-secondary hover:bg-bg-hover'"
                            @click="sourceFilter = 'all'">
                        All
                        <span class="ml-1 opacity-70" x-text="workflows.length"></span>
                    </button>
                    <button class="px-3 py-1.5 rounded-md text-xs font-medium transition-all"
                            :class="sourceFilter === 'library' ? 'bg-accent-primary text-white' : 'bg-bg-tertiary text-text-secondary hover:bg-bg-hover'"
                            @click="sourceFilter = 'library'">
                        Library
                        <span class="ml-1 opacity-70" x-text="workflows.filter(w => w.source === 'library').length"></span>
                    </button>
                    <button class="px-3 py-1.5 rounded-md text-xs font-medium transition-all"
                            :class="sourceFilter === 'user' ? 'bg-accent-primary text-white' : 'bg-bg-tertiary text-text-secondary hover:bg-bg-hover'"
                            @click="sourceFilter = 'user'">
                        My Workflows
                        <span class="ml-1 opacity-70" x-text="workflows.filter(w => w.source === 'user').length"></span>
                    </button>
                </div>

                <!-- Category Filters -->
                <div class="flex gap-2 overflow-x-auto pb-1">
                    <button class="px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all"
                            :class="categoryFilter === 'all' ? 'bg-accent-primary text-text-inverse' : 'bg-bg-tertiary text-text-secondary hover:bg-bg-hover'"
                            @click="categoryFilter = 'all'">
                        All
                    </button>
                    <template x-for="(count, category) in categories" :key="category">
                        <button class="px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all"
                                :class="categoryFilter === category ? 'bg-accent-primary text-text-inverse' : 'bg-bg-tertiary text-text-secondary hover:bg-bg-hover'"
                                @click="categoryFilter = category">
                            <span x-text="category"></span>
                            <span class="ml-1 opacity-70" x-text="`(${count})`"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Workflow Cards Grid -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="grid gap-3">
                    <template x-for="workflow in filteredWorkflows" :key="workflow.id">
                        <div class="bg-bg-secondary border rounded-lg p-4 cursor-pointer transition-all card-hover"
                             :class="selectedWorkflow?.id === workflow.id ? 'border-accent-primary ring-1 ring-accent-primary' : 'border-border-subtle hover:border-border-medium'"
                             @click="selectWorkflow(workflow)">

                            <!-- Workflow Card Header -->
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-md bg-accent-primary/15 flex items-center justify-center text-accent-primary">
                                        <span x-text="getWorkflowIcon(workflow)"></span>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-sm flex items-center gap-2">
                                            <span x-text="workflow.name"></span>
                                            <!-- Status Badge -->
                                            <span x-show="workflow.ready"
                                                  class="px-2 py-0.5 text-xs rounded-full bg-accent-success/20 text-accent-success">
                                                Ready
                                            </span>
                                            <span x-show="!workflow.ready && workflow.model_status"
                                                  class="px-2 py-0.5 text-xs rounded-full bg-accent-warning/20 text-accent-warning">
                                                <span x-text="workflow.model_status.missing"></span> models needed
                                            </span>
                                        </div>
                                        <div class="text-xs text-text-tertiary" x-text="workflow.category"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <p class="text-sm text-text-secondary mb-3 line-clamp-2" x-text="workflow.description || 'No description available'"></p>

                            <!-- Input/Output Types -->
                            <div class="flex items-center gap-3 mb-3 text-xs">
                                <div class="flex items-center gap-1 text-text-tertiary">
                                    <span>Input:</span>
                                    <span class="text-text-secondary" x-text="workflow.input_types?.join(', ') || 'text'"></span>
                                </div>
                                <div class="flex items-center gap-1 text-text-tertiary">
                                    <span>Output:</span>
                                    <span class="text-accent-primary" x-text="workflow.output_types?.join(', ') || 'image'"></span>
                                </div>
                            </div>

                            <!-- Meta Info -->
                            <div class="flex items-center gap-4 text-xs text-text-tertiary">
                                <div class="flex items-center gap-1" x-show="workflow.node_count">
                                    <span>‚óà</span>
                                    <span x-text="`${workflow.node_count} nodes`"></span>
                                </div>
                                <div class="flex items-center gap-1" x-show="workflow.required_models?.length">
                                    <span>‚ö°</span>
                                    <span x-text="`${workflow.required_models.length} models`"></span>
                                </div>
                            </div>

                            <!-- Model Requirements Panel (for user workflows) -->
                            <div x-show="selectedWorkflow && selectedWorkflow.id === workflow.id && workflow.source === 'user'" class="mt-3 pt-3 border-t border-border-primary">
                                <h4 class="text-sm font-medium text-text-secondary mb-2">Required Models</h4>

                                <template x-for="model in workflow.models" :key="model.name">
                                    <div class="flex items-center justify-between py-1.5">
                                        <div class="flex items-center gap-2">
                                            <!-- Status Icon -->
                                            <template x-if="model.installed">
                                                <svg class="w-4 h-4 text-accent-success" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                </svg>
                                            </template>
                                            <template x-if="!model.installed">
                                                <svg class="w-4 h-4 text-accent-warning" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                                </svg>
                                            </template>
                                            <span class="text-sm" x-text="model.name"></span>
                                        </div>

                                        <!-- Actions -->
                                        <div class="flex items-center gap-2">
                                            <template x-if="model.installed">
                                                <span class="text-xs text-accent-success">Installed</span>
                                            </template>
                                            <template x-if="!model.installed && model.preset">
                                                <button @click.stop="installPreset(model.preset.id)"
                                                        class="px-2 py-1 text-xs bg-accent-primary text-white rounded hover:bg-accent-primary/80 flex items-center gap-1">
                                                    ‚¨áÔ∏è Download <span x-text="model.preset.download_size"></span>
                                                </button>
                                            </template>
                                            <template x-if="!model.installed && !model.preset && model.actions">
                                                <div class="flex items-center gap-2">
                                                    <a :href="model.actions.request_preset_url" target="_blank"
                                                       @click.stop
                                                       class="px-2 py-1 text-xs bg-accent-warning/20 text-accent-warning rounded hover:bg-accent-warning/30">
                                                        üìã Report to ZeroClue
                                                    </a>
                                                    <span class="text-xs text-text-tertiary" x-text="`‚Üí ${model.actions.manual_path}`"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <!-- Start Generation Button -->
                                <div class="mt-4 flex justify-end gap-2">
                                    <button x-show="!workflow.ready"
                                            class="px-3 py-1.5 text-sm text-text-secondary hover:text-text-primary">
                                        Start Anyway
                                    </button>
                                    <button @click.stop="selectAndGenerate(workflow)"
                                            :class="workflow.ready ? 'bg-accent-primary' : 'bg-accent-warning'"
                                            class="px-4 py-2 text-sm text-white rounded hover:opacity-80">
                                        <span x-text="workflow.ready ? 'Start Generation' : 'Generate (Missing Models)'"></span>
                                    </button>
                                </div>
                            </div>

                            <!-- Preset Requirements Panel (for library workflows) -->
                            <div x-show="selectedWorkflow && selectedWorkflow.id === workflow.id && workflow.source === 'library'" class="mt-3 pt-3 border-t border-border-primary">
                                <h4 class="text-sm font-medium text-text-secondary mb-2">Required Presets</h4>

                                <template x-for="preset in workflow.required_presets" :key="preset.id">
                                    <div class="flex items-center justify-between py-1.5">
                                        <div class="flex items-center gap-2">
                                            <!-- Status Icon -->
                                            <template x-if="preset.installed">
                                                <svg class="w-4 h-4 text-accent-success" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                </svg>
                                            </template>
                                            <template x-if="!preset.installed">
                                                <svg class="w-4 h-4 text-accent-warning" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                                </svg>
                                            </template>
                                            <span class="text-sm" x-text="preset.name"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <template x-if="preset.installed">
                                                <span class="text-xs text-accent-success">Installed</span>
                                            </template>
                                            <template x-if="!preset.installed">
                                                <button @click.stop="installPreset(preset.id)"
                                                        class="px-2 py-1 text-xs bg-accent-primary text-white rounded hover:bg-accent-primary/80 flex items-center gap-1">
                                                    <span>‚Üì</span>
                                                    <span x-text="preset.download_size || 'Install'"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <!-- Install All & Generate / Generate Buttons -->
                                <div class="mt-4 flex justify-end gap-2">
                                    <button x-show="!workflow.ready"
                                            @click.stop="installAllAndGenerate(workflow)"
                                            class="px-3 py-1.5 text-sm bg-accent-warning text-white rounded hover:opacity-80 flex items-center gap-1">
                                        <span>‚Üì</span>
                                        <span>Install All & Generate</span>
                                    </button>
                                    <button x-show="workflow.ready"
                                            @click.stop="selectAndGenerate(workflow)"
                                            class="px-4 py-2 text-sm bg-accent-primary text-white rounded hover:opacity-80">
                                        Generate
                                    </button>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex gap-2 mt-3 pt-3 border-t border-border-subtle">
                                <button class="flex-1 py-1.5 px-3 rounded-md text-xs font-medium border border-border-medium text-text-secondary hover:bg-bg-hover transition-all"
                                        @click.stop="showWorkflowDetails(workflow)">
                                    Details
                                </button>
                                <button class="flex-1 py-1.5 px-3 rounded-md text-xs font-medium bg-accent-primary text-text-inverse hover:bg-orange-600 transition-all"
                                        :disabled="!isWorkflowReady(workflow)"
                                        @click.stop="selectAndGenerate(workflow)">
                                    Generate
                                    <span class="ml-1">‚Üí</span>
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <div x-show="filteredWorkflows.length === 0" class="text-center py-12">
                        <div class="text-4xl mb-3 text-text-tertiary">‚óâ</div>
                        <div class="text-sm font-medium mb-1">No workflows found</div>
                        <div class="text-xs text-text-tertiary">Try adjusting your search or filters</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Generation Panel (~60%) -->
        <div class="flex-1 flex flex-col bg-bg-primary">
            <!-- Selected Workflow Card -->
            <div class="p-4 border-b border-border-subtle">
                <div x-show="!selectedWorkflow" class="text-center py-8">
                    <div class="text-4xl mb-3 text-text-tertiary">‚óà</div>
                    <div class="text-sm font-medium mb-1">Select a Workflow</div>
                    <div class="text-xs text-text-tertiary">Choose a workflow from the browser to start generating</div>
                </div>

                <div x-show="selectedWorkflow" class="bg-bg-secondary border border-border-subtle rounded-lg p-4" style="display: none;">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-md bg-accent-primary/15 flex items-center justify-center text-accent-primary text-lg">
                                <span x-text="getWorkflowIcon(selectedWorkflow)"></span>
                            </div>
                            <div>
                                <div class="font-semibold" x-text="selectedWorkflow?.name"></div>
                                <div class="text-sm text-text-tertiary" x-text="selectedWorkflow?.category"></div>
                            </div>
                        </div>
                        <button class="text-text-secondary hover:text-text-primary transition-colors"
                                @click="selectedWorkflow = null">
                            ‚úï
                        </button>
                    </div>

                    <!-- Compatibility Status -->
                    <div x-show="workflowCompatibility" class="mb-3">
                        <div x-show="workflowCompatibility?.status === 'ready'" class="flex items-center gap-2 text-xs text-accent-success">
                            <span>‚úì</span>
                            <span>All models available</span>
                        </div>
                        <div x-show="workflowCompatibility?.status === 'check_required'" class="flex items-center gap-2 text-xs text-accent-warning">
                            <span>‚ö†</span>
                            <span x-text="`${workflowCompatibility?.missing_models?.length || 0} models need installation`"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generation Form -->
            <div class="flex-1 overflow-y-auto p-4">
                <div x-show="selectedWorkflow" style="display: none;">
                    <!-- Prompt Input -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">
                            Prompt
                            <span class="text-text-tertiary font-normal">(required)</span>
                        </label>
                        <textarea x-model="prompt"
                                  rows="5"
                                  placeholder="Describe what you want to generate..."
                                  class="w-full px-4 py-3 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-primary placeholder-text-tertiary focus:outline-none focus:border-accent-primary focus:ring-1 focus:ring-accent-primary transition-all resize-none"></textarea>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-2">
                                <!-- LLM Style Selector -->
                                <div class="flex items-center gap-2">
                                    <select x-model="enhanceStyle"
                                            :disabled="isEnhancing"
                                            class="text-xs bg-bg-tertiary border border-border-subtle rounded px-2 py-1 text-text-secondary focus:outline-none focus:border-accent-primary">
                                        <option value="detailed">Detailed</option>
                                        <option value="cinematic">Cinematic</option>
                                        <option value="artistic">Artistic</option>
                                        <option value="minimal">Minimal</option>
                                    </select>
                                    <button class="text-xs text-text-secondary hover:text-text-primary transition-colors disabled:opacity-50"
                                            @click="enhancePrompt()"
                                            :disabled="isEnhancing">
                                        <span x-show="!isEnhancing">‚ú® Enhance</span>
                                        <span x-show="isEnhancing">‚è≥ Enhancing...</span>
                                    </button>
                                </div>
                                <button class="text-xs text-text-secondary hover:text-text-primary transition-colors"
                                        @click="loadPromptTemplate">
                                    üìã Template
                                </button>
                            </div>
                            <div class="text-xs text-text-tertiary">
                                <span x-text="prompt.length"></span> / 2000
                            </div>
                        </div>
                    </div>

                    <!-- Negative Prompt -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">
                            Negative Prompt
                            <span class="text-text-tertiary font-normal">(optional)</span>
                        </label>
                        <textarea x-model="negativePrompt"
                                  rows="2"
                                  placeholder="Describe what to avoid..."
                                  class="w-full px-4 py-3 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-primary placeholder-text-tertiary focus:outline-none focus:border-accent-primary focus:ring-1 focus:ring-accent-primary transition-all resize-none"></textarea>
                    </div>

                    <!-- Image Upload (for I2V/I2I workflows) -->
                    <div x-show="requiresInputImage" class="mb-4" style="display: none;">
                        <label class="block text-sm font-medium text-text-secondary mb-2">
                            Input Image
                            <span class="text-accent-warning font-normal">(required)</span>
                        </label>
                        <div class="border-2 border-dashed border-border-subtle rounded-lg p-6 text-center hover:border-border-medium transition-colors cursor-pointer"
                             @click="$refs.imageInput.click()">
                            <input type="file" x-ref="imageInput" class="hidden" accept="image/*" @change="handleImageUpload">
                            <div x-show="!inputImage" class="text-center">
                                <div class="text-3xl mb-2 text-text-tertiary">‚óâ</div>
                                <div class="text-sm font-medium text-text-secondary">Drop image here or click to upload</div>
                                <div class="text-xs text-text-tertiary mt-1">PNG, JPG up to 10MB</div>
                            </div>
                            <div x-show="inputImage" class="relative inline-block" style="display: none;">
                                <img :src="inputImage" class="max-h-40 rounded-lg">
                                <button class="absolute -top-2 -right-2 w-6 h-6 bg-bg-tertiary rounded-full flex items-center justify-center hover:bg-bg-hover transition-colors text-xs"
                                        @click.stop="inputImage = null">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="mb-4">
                        <button class="flex items-center justify-between w-full text-left py-2"
                                @click="showAdvanced = !showAdvanced">
                            <span class="text-sm font-medium text-text-secondary">Advanced Settings</span>
                            <span class="text-text-tertiary transition-transform" :class="{ 'rotate-180': showAdvanced }">‚ñº</span>
                        </button>
                        <div x-show="showAdvanced" class="mt-3 grid grid-cols-2 gap-4" style="display: none;">
                            <!-- Seed -->
                            <div>
                                <label class="block text-xs text-text-tertiary mb-1">Seed</label>
                                <div class="flex gap-2">
                                    <input type="number" x-model="settings.seed" class="flex-1 px-3 py-2 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-primary focus:outline-none focus:border-accent-primary focus:ring-1 focus:ring-accent-primary transition-all">
                                    <button class="px-3 py-2 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-secondary hover:bg-bg-hover transition-colors"
                                            @click="settings.seed = Math.floor(Math.random() * 2147483647)">
                                        üé≤
                                    </button>
                                </div>
                            </div>
                            <!-- Batch Size -->
                            <div>
                                <label class="block text-xs text-text-tertiary mb-1">Batch Size</label>
                                <input type="number" x-model="settings.batch" min="1" max="10" class="w-full px-3 py-2 bg-bg-tertiary border border-border-subtle rounded-md text-sm text-text-primary focus:outline-none focus:border-accent-primary focus:ring-1 focus:ring-accent-primary transition-all">
                            </div>
                            <!-- Steps -->
                            <div>
                                <label class="block text-xs text-text-tertiary mb-1">Steps</label>
                                <input type="range" x-model="settings.steps" min="1" max="100" class="w-full">
                                <div class="flex justify-between text-xs text-text-tertiary">
                                    <span>1</span>
                                    <span x-text="settings.steps"></span>
                                    <span>100</span>
                                </div>
                            </div>
                            <!-- CFG Scale -->
                            <div>
                                <label class="block text-xs text-text-tertiary mb-1">CFG Scale</label>
                                <input type="range" x-model="settings.cfg" min="1" max="20" step="0.5" class="w-full">
                                <div class="flex justify-between text-xs text-text-tertiary">
                                    <span>1</span>
                                    <span x-text="settings.cfg"></span>
                                    <span>20</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="p-4 border-t border-border-subtle">
                <button class="w-full py-3 px-4 rounded-md text-sm font-medium transition-all"
                        :class="canGenerate ? 'bg-accent-primary text-text-inverse shadow-glow hover:bg-orange-600' : 'bg-bg-tertiary text-text-tertiary cursor-not-allowed'"
                        :disabled="!canGenerate || isGenerating"
                        @click="startGeneration">
                    <span x-show="!isGenerating" class="flex items-center justify-center gap-2">
                        <span>‚ö°</span>
                        <span>Generate</span>
                    </span>
                    <span x-show="isGenerating" class="flex items-center justify-center gap-2">
                        <span class="spinner"></span>
                        <span>Generating...</span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Output & Queue Panel (Collapsible Bottom) -->
    <div class="border-t border-border-subtle bg-bg-secondary">
        <button class="w-full px-6 py-2 flex items-center justify-between text-left hover:bg-bg-hover transition-colors"
                @click="outputPanelExpanded = !outputPanelExpanded">
            <div class="flex items-center gap-3">
                <span class="text-lg">üìä</span>
                <span class="font-medium text-sm">Output & Queue</span>
                <span x-show="currentGeneration" class="text-xs px-2 py-0.5 rounded-full bg-accent-primary/15 text-accent-primary">
                    Generating...
                </span>
                <span x-show="queue.length > 0" class="text-xs text-text-tertiary">
                    <span x-text="queue.length"></span> in queue
                </span>
            </div>
            <span class="text-text-tertiary transition-transform" :class="{ 'rotate-180': outputPanelExpanded }">‚ñº</span>
        </button>

        <!-- Output Panel Content -->
        <div x-show="outputPanelExpanded" class="px-6 pb-4" style="display: none;">
            <div class="grid grid-cols-3 gap-4">
                <!-- Current Generation -->
                <div>
                    <h4 class="text-xs font-semibold text-text-tertiary uppercase mb-2">Current</h4>
                    <div class="bg-bg-tertiary rounded-lg aspect-video flex items-center justify-center">
                        <div x-show="!currentGeneration" class="text-center text-text-tertiary">
                            <div class="text-2xl mb-1">‚óâ</div>
                            <div class="text-xs">No active generation</div>
                        </div>
                        <div x-show="currentGeneration" class="text-center" style="display: none;">
                            <div class="spinner mb-2" style="width: 32px; height: 32px;"></div>
                            <div class="text-sm font-medium" x-text="currentGeneration?.status"></div>
                            <div class="text-xs text-text-tertiary" x-text="`${currentGeneration?.progress}%`"></div>
                        </div>
                    </div>
                </div>

                <!-- Queue -->
                <div>
                    <h4 class="text-xs font-semibold text-text-tertiary uppercase mb-2">Queue</h4>
                    <div class="bg-bg-tertiary rounded-lg p-3 max-h-32 overflow-y-auto">
                        <div x-show="queue.length === 0" class="text-center text-text-tertiary text-xs py-4">
                            Queue is empty
                        </div>
                        <template x-for="(item, index) in queue" :key="item.id">
                            <div class="flex items-center gap-2 py-1" :class="{ 'border-t border-border-subtle': index > 0 }">
                                <div class="w-6 h-6 bg-bg-hover rounded flex items-center justify-center text-xs text-text-tertiary">
                                    <span x-text="index + 1"></span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-medium truncate" x-text="item.workflow_name"></div>
                                </div>
                                <button class="text-xs text-accent-error hover:text-red-400"
                                        @click="cancelQueueItem(item.id)">
                                    ‚úï
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Recent Outputs -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-xs font-semibold text-text-tertiary uppercase">Recent</h4>
                        <a href="/gallery" class="text-xs text-accent-primary hover:underline">View All</a>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <template x-for="output in recentOutputs.slice(0, 6)" :key="output.id">
                            <div class="aspect-square bg-bg-tertiary rounded overflow-hidden cursor-pointer hover:ring-2 hover:ring-accent-primary transition-all"
                                 @click="viewOutput(output)">
                                <img :src="output.thumbnail" class="w-full h-full object-cover">
                            </div>
                        </template>
                        <div x-show="recentOutputs.length === 0" class="col-span-3 aspect-video bg-bg-tertiary rounded flex items-center justify-center">
                            <span class="text-xs text-text-tertiary">No recent outputs</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Disk Space Warning Modal -->
    <div x-show="diskSpaceModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4"
         style="display: none;"
         @click.self="diskSpaceModal = null">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

        <!-- Modal Content -->
        <div class="relative bg-bg-secondary border border-border-medium rounded-lg max-w-md w-full shadow-xl"
             @click.stop>
            <!-- Header -->
            <div class="px-6 py-4 border-b border-border-subtle">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <h3 class="text-lg font-semibold text-accent-warning">Insufficient Disk Space</h3>
                </div>
            </div>

            <!-- Body -->
            <div class="px-6 py-4">
                <p class="text-sm text-text-secondary mb-4">
                    This workflow requires <span class="font-semibold text-text-primary" x-text="diskSpaceModal?.required_gb?.toFixed(1)"></span> GB of downloads,
                    but only <span class="font-semibold text-text-primary" x-text="diskSpaceModal?.available_gb?.toFixed(1)"></span> GB is available on your workspace volume.
                </p>

                <div class="bg-accent-warning/10 border border-accent-warning/30 rounded-lg p-3 mb-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-text-secondary">Shortfall:</span>
                        <span class="font-semibold text-accent-warning" x-text="(diskSpaceModal?.shortfall_gb || 0).toFixed(1) + ' GB'"></span>
                    </div>
                </div>

                <p class="text-xs text-text-tertiary">
                    Options: Delete unused models to free space, or expand your network volume size.
                </p>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-border-subtle flex justify-end gap-3">
                <a href="/models" class="px-4 py-2 text-sm font-medium border border-border-medium rounded-md text-text-secondary hover:bg-bg-hover transition-colors">
                    View Models
                </a>
                <button @click="diskSpaceModal = null"
                        class="px-4 py-2 text-sm font-medium bg-accent-primary text-white rounded-md hover:bg-orange-600 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Workflow Details Modal -->
    <div x-show="detailsWorkflow"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4"
         style="display: none;"
         @click.self="detailsWorkflow = null">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

        <!-- Modal Content -->
        <div class="relative bg-bg-secondary border border-border-medium rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto shadow-xl"
             @click.stop>
            <!-- Header -->
            <div class="sticky top-0 bg-bg-secondary border-b border-border-subtle px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold" x-text="detailsWorkflow?.name"></h3>
                <button class="text-text-secondary hover:text-text-primary transition-colors p-1"
                        @click="detailsWorkflow = null">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="px-6 py-4 space-y-4" x-show="detailsWorkflow">
                <!-- Category Badge -->
                <div class="flex items-center gap-2">
                    <span class="text-xs px-2 py-1 rounded-full bg-accent-primary/15 text-accent-primary"
                          x-text="detailsWorkflow?.category"></span>
                    <span class="text-xs text-text-tertiary"
                          x-text="`${detailsWorkflow?.node_count} nodes`"></span>
                </div>

                <!-- Description -->
                <div>
                    <p class="text-sm text-text-secondary" x-text="detailsWorkflow?.description || 'No description available'"></p>
                </div>

                <!-- Input/Output Types -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-xs text-text-tertiary block mb-1">Input Types</span>
                        <div class="flex flex-wrap gap-1">
                            <template x-for="type in detailsWorkflow?.input_types" :key="type">
                                <span class="text-xs bg-bg-tertiary px-2 py-1 rounded" x-text="type"></span>
                            </template>
                        </div>
                    </div>
                    <div>
                        <span class="text-xs text-text-tertiary block mb-1">Output Types</span>
                        <div class="flex flex-wrap gap-1">
                            <template x-for="type in detailsWorkflow?.output_types" :key="type">
                                <span class="text-xs bg-accent-primary/15 text-accent-primary px-2 py-1 rounded" x-text="type"></span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Required Models -->
                <div x-show="detailsWorkflow?.required_models?.length">
                    <span class="text-xs text-text-tertiary block mb-2">Required Models</span>
                    <div class="space-y-1">
                        <template x-for="model in detailsWorkflow?.required_models" :key="model">
                            <div class="text-xs bg-bg-tertiary px-3 py-2 rounded font-mono" x-text="model"></div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="sticky bottom-0 bg-bg-secondary border-t border-border-subtle px-6 py-4 flex gap-3">
                <button class="btn btn-secondary flex-1 py-2 px-4 rounded-md text-sm font-medium border border-border-medium"
                        @click="detailsWorkflow = null">
                    Close
                </button>
                <button class="btn btn-primary flex-1 py-2 px-4 rounded-md text-sm font-medium bg-accent-primary text-text-inverse shadow-glow hover:bg-orange-600 transition-all"
                        @click="selectAndGenerate(detailsWorkflow); detailsWorkflow = null;">
                    Use This Workflow
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function generatePage() {
    return {
        // UI State
        intentBarExpanded: true,
        outputPanelExpanded: false,
        showAdvanced: false,

        // Intent State
        quickActions: [],
        selectedIntent: null,
        customIntent: '',
        lastIntent: '',
        intentResult: null,

        // Workflow State
        workflows: [],
        categories: {},
        searchQuery: '',
        categoryFilter: 'all',
        sourceFilter: 'all',
        selectedWorkflow: null,
        detailsWorkflow: null,
        workflowCompatibility: null,
        diskSpaceModal: null,

        // Generation State
        prompt: '',
        negativePrompt: '',
        inputImage: null,

        // LLM enhancement state
        enhanceStyle: 'detailed',
        isEnhancing: false,
        llmEnabled: false,
        llmModel: 'phi-3-mini',

        settings: {
            seed: -1,
            batch: 1,
            steps: 30,
            cfg: 7.5
        },
        isGenerating: false,
        currentGeneration: null,

        // Queue State
        queue: [],
        recentOutputs: [],

        // WebSocket
        ws: null,

        async initGeneratePage() {
            await Promise.all([
                this.loadQuickActions(),
                this.loadWorkflows(),
                this.loadRecentOutputs()
            ]);

            // Load LLM settings
            try {
                const settingsResp = await fetch('/api/settings');
                if (settingsResp.ok) {
                    const settings = await settingsResp.json();
                    this.llmEnabled = settings.llm_enabled === true || settings.llm_enabled === 'true';
                    this.llmModel = settings.llm_model || 'phi-3-mini';
                }
            } catch (e) {
                console.warn('Failed to load LLM settings:', e);
            }

            this.initWebSocket();

            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const workflowParam = urlParams.get('workflow');
            if (workflowParam) {
                const workflow = this.workflows.find(w => w.id === workflowParam);
                if (workflow) {
                    this.selectWorkflow(workflow);
                }
            }
        },

        async loadQuickActions() {
            try {
                const response = await fetch('/api/generate/quick-actions');
                if (response.ok) {
                    this.quickActions = await response.json();
                }
            } catch (error) {
                console.error('Failed to load quick actions:', error);
                // Fallback
                this.quickActions = [
                    { id: 't2v', label: 'Video from text', icon: 'üé¨' },
                    { id: 'i2v', label: 'Image to video', icon: 'üé•' },
                    { id: 't2i', label: 'Image from text', icon: 'üñºÔ∏è' },
                    { id: 'upscale', label: 'Upscale', icon: 'üîç' },
                    { id: 'audio', label: 'Generate audio', icon: 'üéµ' }
                ];
            }
        },

        async loadWorkflows() {
            try {
                const response = await fetch('/api/generate/workflows/synced');
                if (response.ok) {
                    const data = await response.json();
                    this.workflows = data.workflows || [];
                    this.categories = data.categories || {};
                }
            } catch (error) {
                console.error('Failed to load workflows:', error);
                this.workflows = [];
                this.categories = {};
            }
        },

        async loadRecentOutputs() {
            try {
                const response = await fetch('/api/gallery/recent?limit=6');
                if (response.ok) {
                    const data = await response.json();
                    this.recentOutputs = data.generations || [];
                }
            } catch (error) {
                console.error('Failed to load recent outputs:', error);
            }
        },

        initWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/generate`;

            try {
                this.ws = new WebSocket(wsUrl);

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.ws.onclose = () => {
                    setTimeout(() => this.initWebSocket(), 5000);
                };
            } catch (error) {
                console.error('WebSocket error:', error);
            }
        },

        handleWebSocketMessage(data) {
            switch (data.type) {
                case 'generation_progress':
                    this.currentGeneration = {
                        id: data.prompt_id,
                        status: data.node || 'Processing...',
                        progress: Math.round(data.progress || 0)
                    };
                    break;

                case 'generation_complete':
                    this.isGenerating = false;
                    this.currentGeneration = null;
                    window.showToast('success', 'Generation Complete', 'Your content is ready!');
                    this.loadRecentOutputs();
                    // Process queue
                    if (this.queue.length > 0) {
                        const next = this.queue.shift();
                        this.startQueueItem(next);
                    }
                    break;

                case 'generation_failed':
                    this.isGenerating = false;
                    this.currentGeneration = null;
                    window.showToast('error', 'Generation Failed', data.error || 'Unknown error');
                    break;

                case 'queue_updated':
                    // Sync queue state if needed
                    break;
            }
        },

        get filteredWorkflows() {
            return this.workflows.filter(w => {
                // Source filter
                if (this.sourceFilter !== 'all' && w.source !== this.sourceFilter) {
                    return false;
                }

                // Category filter
                if (this.categoryFilter !== 'all' && w.category !== this.categoryFilter) {
                    return false;
                }

                // Search filter
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    return w.name.toLowerCase().includes(query) ||
                           (w.description && w.description.toLowerCase().includes(query)) ||
                           (w.input_types && w.input_types.some(t => t.includes(query))) ||
                           (w.output_types && w.output_types.some(t => t.includes(query)));
                }

                return true;
            });
        },

        selectIntent(intentId) {
            this.selectedIntent = intentId;
            const action = this.quickActions.find(a => a.id === intentId);
            if (action) {
                this.lastIntent = action.label;
                // Filter workflows by intent
                this.filterByIntent(intentId);
            }
        },

        async matchIntent() {
            if (!this.customIntent.trim()) return;

            try {
                const response = await fetch('/api/generate/intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: this.customIntent })
                });

                if (response.ok) {
                    this.intentResult = await response.json();
                    if (this.intentResult.matched) {
                        this.lastIntent = this.intentResult.matched_keyword;
                        this.filterByIntent(this.intentResult.suggested_type);
                    }
                }
            } catch (error) {
                console.error('Intent match failed:', error);
            }
        },

        filterByIntent(intentType) {
            // Map intent types to likely output types
            const outputMap = {
                't2v': 'video',
                'i2v': 'video',
                't2i': 'image',
                'i2i': 'image',
                'upscale': 'image',
                'audio': 'audio'
            };

            const targetType = outputMap[intentType];
            if (targetType) {
                // Just update search to help find relevant workflows
                this.searchQuery = targetType;
            }
        },

        selectWorkflow(workflow) {
            this.selectedWorkflow = workflow;
            this.checkCompatibility(workflow.id);
        },

        async checkCompatibility(workflowId) {
            try {
                const response = await fetch(`/api/generate/workflows/${workflowId}/compatibility`);
                if (response.ok) {
                    this.workflowCompatibility = await response.json();
                }
            } catch (error) {
                console.error('Compatibility check failed:', error);
            }
        },

        showWorkflowDetails(workflow) {
            this.detailsWorkflow = workflow;
        },

        selectAndGenerate(workflow) {
            this.selectWorkflow(workflow);
            // Scroll to prompt input
            document.querySelector('textarea')?.focus();
        },

        getWorkflowIcon(workflow) {
            const outputTypes = workflow?.output_types || [];
            if (outputTypes.includes('video')) return 'üé¨';
            if (outputTypes.includes('audio')) return 'üéµ';
            if (outputTypes.includes('image')) return 'üñºÔ∏è';
            return '‚óà';
        },

        isWorkflowReady(workflow) {
            // Use the synced ready status from the API
            return workflow.ready === true;
        },

        get requiresInputImage() {
            const inputTypes = this.selectedWorkflow?.input_types || [];
            return inputTypes.includes('image');
        },

        get canGenerate() {
            if (!this.selectedWorkflow) return false;
            if (!this.prompt.trim()) return false;
            if (this.requiresInputImage && !this.inputImage) return false;
            if (this.workflowCompatibility?.can_generate === false) return false;
            return true;
        },

        handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.inputImage = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        },

        async enhancePrompt() {
            if (!this.prompt.trim()) {
                window.showToast('warning', 'Empty Prompt', 'Enter a prompt to enhance');
                return;
            }

            // Static fallback enhancement
            const fallbackEnhance = () => {
                const mods = ['highly detailed', 'professional quality', 'cinematic lighting'];
                this.prompt = `${this.prompt.trim()}, ${mods.join(', ')}`;
                window.showToast('info', 'Quick Enhance', 'Added quality modifiers');
            };

            // If LLM disabled, use fallback
            if (!this.llmEnabled) {
                fallbackEnhance();
                return;
            }

            // Call LLM API
            this.isEnhancing = true;
            try {
                const response = await fetch('/api/llm/enhance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: this.prompt.trim(),
                        style: this.enhanceStyle,
                        model: this.llmModel
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.enhanced_prompt) {
                        this.prompt = data.enhanced_prompt;
                        window.showToast('success', 'Prompt Enhanced', `Style: ${this.enhanceStyle}`);
                    } else {
                        throw new Error(data.error || 'Enhancement failed');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API error: ${response.status}`);
                }
            } catch (error) {
                console.error('LLM enhance error:', error);
                window.showToast('error', 'Enhancement Failed', error.message);
                fallbackEnhance(); // Graceful fallback
            } finally {
                this.isEnhancing = false;
            }
        },

        loadPromptTemplate() {
            const templates = {
                'video': 'A cinematic drone shot of a misty mountain landscape at sunrise, golden hour lighting, 4K quality',
                'image': 'A futuristic cityscape at night, neon lights, cyberpunk aesthetic, highly detailed',
                'default': 'Describe what you want to create...'
            };

            const outputTypes = this.selectedWorkflow?.output_types || [];
            const template = outputTypes.includes('video') ? templates.video : templates.image;
            this.prompt = template;
        },

        async startGeneration() {
            if (!this.canGenerate) return;

            this.isGenerating = true;
            this.currentGeneration = {
                id: null,
                status: 'Starting...',
                progress: 0
            };

            try {
                const payload = {
                    workflow_id: this.selectedWorkflow.id,
                    prompt: this.prompt,
                    negative_prompt: this.negativePrompt,
                    settings: this.settings
                };

                if (this.inputImage) {
                    payload.input_image = this.inputImage;
                }

                const response = await fetch('/api/generate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    this.currentGeneration.id = result.prompt_id;

                    // Add batch items to queue
                    if (this.settings.batch > 1) {
                        for (let i = 1; i < this.settings.batch; i++) {
                            this.queue.push({
                                id: `${result.prompt_id}-${i}`,
                                workflow_id: this.selectedWorkflow.id,
                                workflow_name: this.selectedWorkflow.name,
                                prompt: this.prompt
                            });
                        }
                    }

                    window.showToast('success', 'Generation Started', result.message);
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }
            } catch (error) {
                console.error('Generation error:', error);
                this.isGenerating = false;
                this.currentGeneration = null;
                window.showToast('error', 'Generation Failed', error.message);
            }
        },

        async cancelQueueItem(itemId) {
            try {
                await fetch(`/api/generate/${itemId}/cancel`, { method: 'POST' });
                this.queue = this.queue.filter(item => item.id !== itemId);
                window.showToast('info', 'Cancelled', 'Item removed from queue');
            } catch (error) {
                console.error('Cancel failed:', error);
            }
        },

        async startQueueItem(item) {
            // Start generation for queued item
            this.selectedWorkflow = this.workflows.find(w => w.id === item.workflow_id);
            this.prompt = item.prompt;
            await this.startGeneration();
        },

        viewOutput(output) {
            // Navigate to gallery or show output details
            window.location.href = `/gallery?id=${output.id}`;
        },

        async installPreset(presetId) {
            try {
                const response = await fetch(`/api/presets/${presetId}/install`, { method: 'POST' });
                if (response.ok) {
                    window.showToast('success', 'Installation Started', 'Preset installation has begun');
                    // Refresh workflows to get updated status
                    await this.loadWorkflows();
                } else {
                    const error = await response.json();
                    window.showToast('error', 'Installation Failed', error.detail || 'Failed to start installation');
                }
            } catch (error) {
                console.error('Install preset failed:', error);
                window.showToast('error', 'Installation Failed', error.message);
            }
        },

        async installAllAndGenerate(workflow) {
            if (!workflow.required_presets) return;

            const missingPresets = workflow.required_presets.filter(p => !p.installed);
            if (missingPresets.length === 0) {
                // All installed, just generate
                this.selectAndGenerate(workflow);
                return;
            }

            // Check disk space requirements first
            try {
                const checkResponse = await fetch(`/api/workflows/registry/${workflow.id}/check-requirements`);
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    if (checkData.disk_check && !checkData.disk_check.can_proceed) {
                        // Show disk space warning modal
                        this.diskSpaceModal = checkData.disk_check;
                        return;
                    }
                }
            } catch (error) {
                console.error('Failed to check requirements:', error);
                // Continue with installation if check fails
            }

            // Install all missing presets
            let installedCount = 0;
            let failedCount = 0;

            for (const preset of missingPresets) {
                try {
                    const response = await fetch(`/api/presets/${preset.id}/install`, { method: 'POST' });
                    if (response.ok) {
                        installedCount++;
                    } else {
                        failedCount++;
                    }
                } catch (error) {
                    console.error(`Failed to install preset ${preset.id}:`, error);
                    failedCount++;
                }
            }

            if (installedCount > 0) {
                window.showToast('success', 'Installation Started',
                    `${installedCount} preset(s) queued for download. Generation will start when ready.`);
                // Refresh workflows to get updated status
                await this.loadWorkflows();
            }

            if (failedCount > 0) {
                window.showToast('warning', 'Partial Installation',
                    `${failedCount} preset(s) failed to install.`);
            }
        }
    }
}
</script>
{% endblock %}
